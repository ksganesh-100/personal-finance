<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Net Worth Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6; /* Light gray background */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        .container {
            width: 100%;
            max-width: 1200px; /* Max width for content */
            padding: 1rem;
            box-sizing: border-box;
        }
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }
        .hidden {
            display: none !important;
        }
        /* Navigation specific styles */
        .nav-link {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
        }
        .nav-link.active {
            background-color: #00C49F; /* Highlight color for active link */
            color: white;
            font-weight: 600;
        }
        .nav-link:hover:not(.active) {
            background-color: #374151; /* Darker hover for non-active */
        }
    </style>
</head>
<body>
    <div id="app" class="container mx-auto p-4 bg-white shadow-lg rounded-lg mt-8 mb-8">
        <!-- Loading State -->
        <div id="loading-state" class="flex items-center justify-center min-h-screen hidden">
            <div class="text-xl font-semibold text-gray-700">Loading Net Worth Tracker...</div>
        </div>

        <!-- Error State -->
        <div id="error-state" class="flex items-center justify-center min-h-screen hidden">
            <div class="text-xl font-semibold text-red-600 p-4 bg-red-100 rounded-lg">Error: <span id="error-message"></span></div>
        </div>

        <!-- Authentication View -->
        <div id="auth-view" class="view-section hidden flex flex-col items-center justify-center min-h-[60vh]">
            <h1 class="text-4xl font-bold text-gray-800 mb-8">Welcome to Net Worth Tracker</h1>
            <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
                <h2 id="auth-form-title" class="text-2xl font-semibold text-center text-gray-800 mb-6">Sign In</h2>
                <p id="auth-error-message" class="text-red-500 text-center mb-4 hidden"></p>

                <div class="mb-4">
                    <label for="auth-email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                    <input
                        type="email"
                        id="auth-email"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        placeholder="your@example.com"
                    />
                </div>
                <div class="mb-6">
                    <label for="auth-password" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                    <input
                        type="password"
                        id="auth-password"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                        placeholder="********"
                    />
                </div>
                <div class="flex flex-col space-y-4">
                    <button
                        id="sign-in-btn"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-200 ease-in-out"
                    >
                        Sign In
                    </button>
                    <button
                        id="sign-up-btn"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-200 ease-in-out"
                    >
                        Sign Up
                    </button>
                    <button
                        id="toggle-auth-mode-btn"
                        class="text-blue-500 hover:text-blue-700 text-sm mt-4"
                    >
                        Switch to Sign Up
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Application Content (initially hidden) -->
        <div id="main-content" class="hidden">
            <!-- Header and Navigation -->
            <header class="bg-gray-900 text-white p-4 rounded-t-lg flex flex-col md:flex-row items-center justify-between mb-6">
                <div class="text-2xl font-bold text-teal-400 mb-4 md:mb-0">networth</div>
                <nav class="flex space-x-4 items-center">
                    <button id="nav-dashboard" class="nav-link active">Dashboard</button>
                    <button id="nav-accounts" class="nav-link">Accounts</button>
                    <button id="nav-settings" class="nav-link">Settings</button>
                    <button id="sign-out-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-200 ease-in-out transform hover:scale-105 ml-4">Sign Out</button>
                </nav>
            </header>

            <!-- Dashboard View -->
            <div id="dashboard-view" class="view-section">
                <h1 class="text-4xl font-bold text-center text-gray-800 mb-6">Your Dashboard</h1>
                <p class="text-center text-gray-600 mb-8">
                    Welcome, User ID: <span id="user-id-display"></span>! Track your financial journey.
                </p>

                <!-- Net Worth Summary -->
                <div class="bg-blue-600 text-white p-6 rounded-lg shadow-md mb-8 flex flex-col md:flex-row items-center justify-between">
                    <div class="flex items-center mb-4 md:mb-0">
                        <!-- DollarSign Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 mr-4"><circle cx="12" cy="12" r="10"></circle><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path><path d="M12 2v20"></path></svg>
                        <div>
                            <h2 class="text-2xl font-semibold">Total Net Worth</h2>
                            <p id="total-net-worth" class="text-4xl font-bold mt-2"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <label for="currency-select" class="text-lg">Display in:</label>
                        <select
                            id="currency-select"
                            class="p-2 rounded-md bg-blue-700 text-white border border-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-400"
                        >
                            <option value="INR">INR</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                        </select>
                        <button
                            id="take-snapshot-btn"
                            class="bg-blue-700 hover:bg-blue-800 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-200 ease-in-out transform hover:scale-105"
                        >
                            Take Snapshot
                        </button>
                    </div>
                </div>

                <!-- Charts Section - Optimized Layout -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- Net Worth Historical Graph -->
                    <div class="md:col-span-2 p-6 bg-gray-50 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                            <!-- BarChart Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
                            Net Worth History
                        </h2>
                        <div class="flex justify-end mb-4">
                            <label for="chart-aggregation-select" class="mr-2 text-gray-700">View by:</label>
                            <select id="chart-aggregation-select" class="p-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400">
                                <option value="monthly">Month</option>
                                <option value="quarterly">Quarter</option>
                                <option value="yearly">Year</option>
                            </select>
                        </div>
                        <p id="no-history-message" class="text-gray-500 text-center py-8 hidden">Take a few snapshots to see your net worth history here.</p>
                        <div id="net-worth-chart-container" class="relative w-full h-80 hidden">
                            <canvas id="netWorthChart"></canvas>
                        </div>
                    </div>

                    <!-- Asset Distribution Pie Chart -->
                    <div class="p-6 bg-gray-50 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                            <!-- LayoutGrid Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                            Asset Distribution by Group
                        </h2>
                        <p id="no-allocation-message" class="text-gray-500 text-center py-8 hidden">Add assets to see your allocation breakdown.</p>
                        <div id="allocation-chart-container" class="relative w-full h-80 hidden">
                            <canvas id="assetAllocationChart"></canvas>
                        </div>
                    </div>

                    <!-- New: Equity vs. Non-Equity Allocation Pie Chart -->
                    <div class="p-6 bg-gray-50 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                            <!-- Pie Chart Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2"><path d="M10 3.129a10 10 0 1 1-6.983 6.983"></path><path d="M10 3.129v6.871h10"></path></svg>
                            Equity vs. Non-Equity Allocation
                        </h2>
                        <p id="no-equity-allocation-message" class="text-gray-500 text-center py-8 hidden">Enter "Equity %" for your assets to see this allocation.</p>
                        <div id="equity-allocation-chart-container" class="relative w-full h-80 hidden">
                            <canvas id="equityAllocationChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Transaction Log -->
                <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                        <!-- BarChart Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
                        Transaction History
                    </h2>
                    <p id="no-transactions-message" class="text-gray-500 text-center py-8 hidden">No transactions recorded yet.</p>
                    <div id="transactions-table-container" class="overflow-x-auto rounded-lg shadow-md hidden">
                        <table class="min-w-full bg-white border-collapse">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider rounded-tl-lg">Date</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">Asset</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">Type</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">Amount Changed</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">New Value</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider rounded-tr-lg">Description</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-table-body" class="divide-y divide-gray-200">
                                <!-- Transaction rows will be injected here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Accounts View -->
            <div id="accounts-view" class="view-section hidden">
                <h1 class="text-4xl font-bold text-center text-gray-800 mb-6">Your Accounts</h1>

                <!-- Add Asset Button -->
                <div class="flex justify-end mb-6">
                    <button
                        id="add-asset-btn"
                        class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center"
                    >
                        <!-- Plus Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M12 5v14"></path><path d="M5 12h14"></path></svg>
                        Add New Asset
                    </button>
                </div>

                <!-- Assets List -->
                <div class="mb-8">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                        <!-- LayoutGrid Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                        All Assets
                    </h2>
                    <p id="no-assets-message" class="text-gray-500 text-center py-8 hidden">No assets added yet. Click "Add New Asset" to get started!</p>
                    <div id="assets-table-container" class="overflow-x-auto rounded-lg shadow-md hidden">
                        <table class="min-w-full bg-white border-collapse">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider rounded-tl-lg">Asset Name</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">Group</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">Value</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">Value (<span id="display-currency-assets">INR</span>)</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">Equity %</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">Last Updated</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider rounded-tr-lg">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="assets-table-body" class="divide-y divide-gray-200">
                                <!-- Asset rows will be injected here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-end mt-4">
                        <button
                            id="export-csv-btn"
                            class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center"
                        >
                            Export to CSV
                        </button>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="view-section hidden">
                <h1 class="text-4xl font-bold text-center text-gray-800 mb-6">Settings</h1>

                <!-- Manage Account Groups -->
                <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Manage Account Groups</h2>
                    <p id="account-group-error" class="text-red-500 mb-4 hidden"></p>
                    <div class="flex mb-4">
                        <input
                            type="text"
                            id="new-group-name"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mr-2"
                            placeholder="New Group Name"
                        />
                        <button
                            id="add-group-btn"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                        >
                            Add Group
                        </button>
                    </div>
                    <div id="account-groups-list">
                        <!-- Account groups will be rendered here -->
                        <p id="no-groups-message" class="text-gray-500 text-center py-4 hidden">No custom groups added yet.</p>
                        <table id="account-groups-table" class="min-w-full bg-white border-collapse hidden">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="py-2 px-4 text-left text-sm font-medium text-gray-700 uppercase">Group Name</th>
                                    <th class="py-2 px-4 text-left text-sm font-medium text-gray-700 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="account-groups-table-body" class="divide-y divide-gray-200">
                                <!-- Group rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Manage Currency Conversion Rates -->
                <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Manage Currency Conversion Rates</h2>
                    <p id="currency-rate-error" class="text-red-500 mb-4 hidden"></p>
                    <div class="mb-4">
                        <label for="usd-to-inr-rate" class="block text-gray-700 text-sm font-bold mb-2">1 USD = <span id="usd-currency-display">INR</span></label>
                        <input
                            type="number"
                            id="usd-to-inr-rate"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            min="0.01"
                            step="0.01"
                            placeholder="e.g., 83.50"
                        />
                    </div>
                    <div class="mb-6">
                        <label for="eur-to-inr-rate" class="block text-gray-700 text-sm font-bold mb-2">1 EUR = <span id="eur-currency-display">INR</span></label>
                        <input
                            type="number"
                            id="eur-to-inr-rate"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            min="0.01"
                            step="0.01"
                            placeholder="e.g., 90.00"
                        />
                    </div>
                    <div>
                        <button
                            id="save-currency-rates-btn"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                        >
                            Save Rates
                        </button>
                    </div>
                </div>

                <!-- New: Import/Export Net Worth History -->
                <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Import/Export Net Worth History</h2>
                    <p id="history-csv-message" class="text-red-500 mb-4 hidden"></p>

                    <div class="mb-4">
                        <label for="csv-upload-input" class="block text-gray-700 text-sm font-bold mb-2">Upload History (CSV):</label>
                        <input type="file" id="csv-upload-input" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        <button id="upload-history-csv-btn" class="mt-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Upload CSV
                        </button>
                    </div>

                    <div>
                        <button id="export-history-csv-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Export History to CSV
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Asset Modal -->
    <div id="add-asset-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Add New Asset</h3>
            <p id="add-asset-error" class="text-red-500 mb-4 hidden"></p>
            <div class="mb-4">
                <label for="new-asset-name" class="block text-gray-700 text-sm font-bold mb-2">Asset Name:</label>
                <input
                    type="text"
                    id="new-asset-name"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    placeholder="e.g., Savings Account, Google Stock"
                />
            </div>
            <div class="mb-4">
                <label for="new-asset-value" class="block text-gray-700 text-sm font-bold mb-2">Current Value:</label>
                <input
                    type="number"
                    id="new-asset-value"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    min="0"
                    step="0.01"
                    placeholder="e.g., 10000.00"
                />
            </div>
            <div class="mb-4">
                <label for="new-asset-currency" class="block text-gray-700 text-sm font-bold mb-2">Currency:</label>
                <select
                    id="new-asset-currency"
                    class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                >
                    <option value="INR">INR</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="new-asset-group" class="block text-gray-700 text-sm font-bold mb-2">Asset Group:</label>
                <select
                    id="new-asset-group"
                    class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                >
                    <option value="">Select a group (Optional)</option>
                    <!-- Options will be dynamically populated by JS -->
                </select>
            </div>
            <!-- New: Equity Percentage Input for Add Asset Modal -->
            <div class="mb-6">
                <label for="new-asset-equity-percentage" class="block text-gray-700 text-sm font-bold mb-2">Equity % (0-100):</label>
                <input
                    type="number"
                    id="new-asset-equity-percentage"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    min="0"
                    max="100"
                    step="1"
                    value="100"
                    placeholder="e.g., 75"
                />
            </div>
            <div class="flex items-center justify-between">
                <button
                    id="save-new-asset-btn"
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                    Add Asset
                </button>
                <button
                    id="cancel-add-asset-btn"
                    class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Adjust Value Modal -->
    <div id="adjust-value-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Adjust Value for <span id="adjust-asset-name"></span> (<span id="adjust-asset-currency"></span>)</h3>
            <p class="text-gray-600 mb-4">Current Value: <span id="adjust-current-value"></span></p>
            <p id="adjust-value-error" class="text-red-500 mb-4 hidden"></p>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Update Type:</label>
                <div class="flex space-x-4">
                    <label class="inline-flex items-center">
                        <input
                            type="radio"
                            class="form-radio text-blue-600"
                            name="transactionType"
                            value="add"
                            checked
                        />
                        <span class="ml-2">Add</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input
                            type="radio"
                            class="form-radio text-blue-600"
                            name="transactionType"
                            value="subtract"
                        />
                        <span class="ml-2">Subtract</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input
                            type="radio"
                            class="form-radio text-blue-600"
                            name="transactionType"
                            value="absolute"
                        />
                        <span class="ml-2">Set Absolute Value</span>
                    </label>
                </div>
            </div>

            <div id="transaction-amount-section" class="mb-4">
                <label for="transaction-amount" class="block text-gray-700 text-sm font-bold mb-2">Amount:</label>
                <input
                    type="number"
                    id="transaction-amount"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    min="0"
                    step="0.01"
                    placeholder="e.g., 500.00"
                />
            </div>
            <div id="transaction-absolute-value-section" class="mb-4 hidden">
                <label for="transaction-absolute-value" class="block text-gray-700 text-sm font-bold mb-2">New Absolute Value:</label>
                <input
                    type="number"
                    id="transaction-absolute-value"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    min="0"
                    step="0.01"
                    placeholder="e.g., 10500.00"
                />
            </div>

            <div class="mb-6">
                <label for="transaction-description" class="block text-gray-700 text-sm font-bold mb-2">Description (Optional):</label>
                <input
                    type="text"
                    id="transaction-description"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    placeholder="e.g., Monthly deposit, Stock sale"
                />
            </div>
            <div class="flex items-center justify-between">
                <button
                    id="apply-transaction-btn"
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                    Apply Change
                </button>
                <button
                    id="cancel-transaction-btn"
                    class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Asset Modal -->
    <div id="edit-asset-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Edit Asset</h3>
            <p id="edit-asset-error" class="text-red-500 mb-4 hidden"></p>
            <div class="mb-4">
                <label for="edit-asset-name" class="block text-gray-700 text-sm font-bold mb-2">Asset Name:</label>
                <input
                    type="text"
                    id="edit-asset-name"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    placeholder="e.g., Savings Account"
                />
            </div>
            <div class="mb-4">
                <label for="edit-asset-group" class="block text-gray-700 text-sm font-bold mb-2">Asset Group:</label>
                <select
                    id="edit-asset-group"
                    class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                >
                    <option value="">Select a group (Optional)</option>
                    <!-- Options will be dynamically populated by JS -->
                </select>
            </div>
            <!-- New: Equity Percentage Input for Edit Asset Modal -->
            <div class="mb-6">
                <label for="edit-asset-equity-percentage" class="block text-gray-700 text-sm font-bold mb-2">Equity % (0-100):</label>
                <input
                    type="number"
                    id="edit-asset-equity-percentage"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    min="0"
                    max="100"
                    step="1"
                    placeholder="e.g., 75"
                />
            </div>
            <div class="flex items-center justify-between">
                <button
                    id="save-edited-asset-btn"
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                    Save Changes
                </button>
                <button
                    id="cancel-edit-asset-btn"
                    class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Account Group Modal -->
    <div id="edit-group-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Edit Account Group</h3>
            <p id="edit-group-error" class="text-red-500 mb-4 hidden"></p>
            <div class="mb-4">
                <label for="edit-group-name" class="block text-gray-700 text-sm font-bold mb-2">Group Name:</label>
                <input
                    type="text"
                    id="edit-group-name"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    placeholder="e.g., New Group Name"
                />
            </div>
            <div class="flex items-center justify-between">
                <button
                    id="save-edited-group-btn"
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                    Save Changes
                </button>
                <button
                    id="cancel-edit-group-btn"
                    class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                    Cancel
                </button>
            </div>
        </div>
    </div>


    <!-- Chart.js CDN (for graphs) - Loaded as a regular script -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase CDN -->
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, onSnapshot, addDoc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your Firebase project configuration
        const firebaseConfig = {
          apiKey: "AIzaSyAG5hRXMoRCAJtE_SK_9vAHKzTfPDzWips",
          authDomain: "personal-finance-b265a.firebaseapp.com",
          projectId: "personal-finance-b265a",
          storageBucket: "personal-finance-b265a.firebasestorage.app",
          messagingSenderId: "704749934703",
          appId: "1:704749934703:web:2b5d572df1e2819cf1d59a",
          measurementId: "G-DXTCNEJ57E"
        };

        // Global Firebase instances and data
        let app;
        let db;
        let auth;
        let currentUser = null;
        let assetsData = [];
        let transactionsData = [];
        let netWorthSnapshotsData = [];
        let customAccountGroupsData = []; // New: Stores custom account groups
        let primaryDisplayCurrency = 'INR';
        let selectedAssetForAdjustment = null; // Stores the asset object for adjustment modal
        let currentEditAssetId = null; // Stores the ID of the asset being edited
        let currentEditGroupId = null; // New: Stores the ID of the group being edited
        let currentChartAggregation = 'monthly'; // Default chart aggregation, changed from 'daily'

        // Chart instances
        let netWorthChartInstance = null;
        let allocationChartInstance = null;
        let equityAllocationChartInstance = null; // New: Equity Allocation Chart instance

        // DOM Element References
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const errorMessageSpan = document.getElementById('error-message');
        
        // Auth View Elements
        const authView = document.getElementById('auth-view');
        const authFormTitle = document.getElementById('auth-form-title');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const signInBtn = document.getElementById('sign-in-btn');
        const signUpBtn = document.getElementById('sign-up-btn');
        const toggleAuthModeBtn = document.getElementById('toggle-auth-mode-btn');
        const authErrorMessage = document.getElementById('auth-error-message');
        let isSignInMode = true; // State for auth form

        // Main Content Elements
        const mainContent = document.getElementById('main-content');
        const userIdDisplay = document.getElementById('user-id-display');
        const totalNetWorthDisplay = document.getElementById('total-net-worth');
        const currencySelect = document.getElementById('currency-select');
        const takeSnapshotBtn = document.getElementById('take-snapshot-btn');
        const signOutBtn = document.getElementById('sign-out-btn'); // New: Sign Out button

        // Navigation buttons
        const navDashboardBtn = document.getElementById('nav-dashboard');
        const navAccountsBtn = document.getElementById('nav-accounts');
        const navSettingsBtn = document.getElementById('nav-settings');

        // View sections
        const dashboardView = document.getElementById('dashboard-view');
        const accountsView = document.getElementById('accounts-view');
        const settingsView = document.getElementById('settings-view');

        // Dashboard specific elements (moved from main content)
        const netWorthChartCanvas = document.getElementById('netWorthChart');
        const noHistoryMessage = document.getElementById('no-history-message');
        const netWorthChartContainer = document.getElementById('net-worth-chart-container');
        const assetAllocationChartCanvas = document.getElementById('assetAllocationChart');
        const noAllocationMessage = document.getElementById('no-allocation-message');
        const allocationChartContainer = document.getElementById('allocation-chart-container');
        const equityAllocationChartCanvas = document.getElementById('equityAllocationChart'); // New: Equity Allocation Chart Canvas
        const noEquityAllocationMessage = document.getElementById('no-equity-allocation-message'); // New: Equity Allocation Message
        const equityAllocationChartContainer = document.getElementById('equity-allocation-chart-container'); // New: Equity Allocation Chart Container
        const transactionsTableBody = document.getElementById('transactions-table-body');
        const noTransactionsMessage = document.getElementById('no-transactions-message');
        const transactionsTableContainer = document.getElementById('transactions-table-container');
        const chartAggregationSelect = document.getElementById('chart-aggregation-select'); // New: Chart aggregation select


        // Accounts View specific elements
        const addAssetBtn = document.getElementById('add-asset-btn');
        const assetsTableBody = document.getElementById('assets-table-body');
        const noAssetsMessage = document.getElementById('no-assets-message');
        const assetsTableContainer = document.getElementById('assets-table-container');
        const displayCurrencyAssets = document.getElementById('display-currency-assets');
        const exportCsvBtn = document.getElementById('export-csv-btn');

        // Settings View specific elements
        const newGroupNameInput = document.getElementById('new-group-name');
        const addGroupBtn = document.getElementById('add-group-btn');
        const accountGroupError = document.getElementById('account-group-error');
        const accountGroupsList = document.getElementById('account-groups-list');
        const noGroupsMessage = document.getElementById('no-groups-message');
        const accountGroupsTable = document.getElementById('account-groups-table');
        const accountGroupsTableBody = document.getElementById('account-groups-table-body');

        // Currency Rate Management elements
        const usdToInrRateInput = document.getElementById('usd-to-inr-rate');
        const eurToInrRateInput = document.getElementById('eur-to-inr-rate');
        const saveCurrencyRatesBtn = document.getElementById('save-currency-rates-btn');
        const currencyRateError = document.getElementById('currency-rate-error');
        const usdCurrencyDisplay = document.getElementById('usd-currency-display');
        const eurCurrencyDisplay = document.getElementById('eur-currency-display');


        // CSV History Import/Export elements
        const csvUploadInput = document.getElementById('csv-upload-input');
        const uploadHistoryCsvBtn = document.getElementById('upload-history-csv-btn');
        const exportHistoryCsvBtn = document.getElementById('export-history-csv-btn');
        const historyCsvMessage = document.getElementById('history-csv-message');


        // Modals
        const addAssetModal = document.getElementById('add-asset-modal');
        const addAssetError = document.getElementById('add-asset-error');
        const newAssetNameInput = document.getElementById('new-asset-name');
        const newAssetValueInput = document.getElementById('new-asset-value');
        const newAssetCurrencySelect = document.getElementById('new-asset-currency');
        const newAssetGroupSelect = document.getElementById('new-asset-group');
        const newAssetEquityPercentageInput = document.getElementById('new-asset-equity-percentage'); // New: Equity % for Add Asset
        const saveNewAssetBtn = document.getElementById('save-new-asset-btn');
        const cancelAddAssetBtn = document.getElementById('cancel-add-asset-btn');

        const adjustValueModal = document.getElementById('adjust-value-modal');
        const adjustAssetNameSpan = document.getElementById('adjust-asset-name');
        const adjustAssetCurrencySpan = document.getElementById('adjust-asset-currency');
        const adjustCurrentValueSpan = document.getElementById('adjust-current-value');
        const adjustValueError = document.getElementById('adjust-value-error');
        const transactionTypeRadios = document.querySelectorAll('input[name="transactionType"]');
        const transactionAmountSection = document.getElementById('transaction-amount-section');
        const transactionAmountInput = document.getElementById('transaction-amount');
        const transactionAbsoluteValueSection = document.getElementById('transaction-absolute-value-section');
        const transactionAbsoluteValueInput = document.getElementById('transaction-absolute-value');
        const transactionDescriptionInput = document.getElementById('transaction-description');
        const applyTransactionBtn = document.getElementById('apply-transaction-btn');
        const cancelTransactionBtn = document.getElementById('cancel-transaction-btn');

        const editAssetModal = document.getElementById('edit-asset-modal');
        const editAssetError = document.getElementById('edit-asset-error');
        const editAssetNameInput = document.getElementById('edit-asset-name');
        const editAssetGroupSelect = document.getElementById('edit-asset-group');
        const editAssetEquityPercentageInput = document.getElementById('edit-asset-equity-percentage'); // New: Equity % for Edit Asset
        const saveEditedAssetBtn = document.getElementById('save-edited-asset-btn');
        const cancelEditAssetBtn = document.getElementById('cancel-edit-asset-btn');

        const editGroupModal = document.getElementById('edit-group-modal'); // New: Edit Group Modal
        const editGroupNameInput = document.getElementById('edit-group-name');
        const editGroupError = document.getElementById('edit-group-error');
        const saveEditedGroupBtn = document.getElementById('save-edited-group-btn');
        const cancelEditGroupBtn = document.getElementById('cancel-edit-group-btn');


        // Exchange rates (simplified, hardcoded initially, will be loaded from Firestore)
        let EXCHANGE_RATES = {
            USD_TO_INR: 83.5,
            EUR_TO_INR: 90.0,
            INR_TO_USD: 1 / 83.5,
            INR_TO_EUR: 1 / 90.0,
            USD_TO_EUR: 0.92,
            EUR_TO_USD: 1 / 0.92
        };

        // Function to convert value to a target currency
        function convertCurrency(value, fromCurrency, toCurrency) {
            if (fromCurrency === toCurrency) {
                return value;
            }

            let valueInINR = value;
            if (fromCurrency === 'USD') {
                valueInINR = value * EXCHANGE_RATES.USD_TO_INR;
            } else if (fromCurrency === 'EUR') {
                valueInINR = value * EXCHANGE_RATES.EUR_TO_INR;
            }

            if (toCurrency === 'INR') {
                return valueInINR;
            } else if (toCurrency === 'USD') {
                return valueInINR * EXCHANGE_RATES.INR_TO_USD;
            } else if (toCurrency === 'EUR') {
                return valueInINR * EXCHANGE_RATES.INR_TO_EUR;
            }
            return value;
        }

        // --- UI State Management ---
        let currentActiveView = 'dashboard'; // Default view

        function showLoading() {
            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');
            authView.classList.add('hidden'); // Hide auth view during loading
            mainContent.classList.add('hidden');
        }

        function showError(message) {
            loadingState.classList.add('hidden');
            errorState.classList.remove('hidden');
            authView.classList.add('hidden');
            mainContent.classList.add('hidden');
            errorMessageSpan.textContent = message;
        }

        function showAuthView() {
            loadingState.classList.add('hidden');
            errorState.classList.add('hidden');
            mainContent.classList.add('hidden');
            authView.classList.remove('hidden');
            authErrorMessage.classList.add('hidden'); // Clear previous auth errors
        }

        function showApp() {
            loadingState.classList.add('hidden');
            errorState.classList.add('hidden');
            authView.classList.add('hidden'); // Hide auth view when authenticated
            mainContent.classList.remove('hidden');
            renderActiveView(currentActiveView); // Render the initial view
        }

        function showModal(modalElement, errorElement) {
            modalElement.classList.remove('hidden');
            if (errorElement) errorElement.classList.add('hidden');
        }

        function hideModal(modalElement, errorElement) {
            modalElement.classList.add('hidden');
            if (errorElement) errorElement.classList.add('hidden');
        }

        // Function to switch between views
        function renderActiveView(viewId) {
            currentActiveView = viewId;
            // Hide all view sections
            dashboardView.classList.add('hidden');
            accountsView.classList.add('hidden');
            settingsView.classList.add('hidden');

            // Remove active class from all nav links
            navDashboardBtn.classList.remove('active');
            navAccountsBtn.classList.remove('active');
            navSettingsBtn.classList.remove('active');

            // Show the selected view and set active nav link
            if (viewId === 'dashboard') {
                dashboardView.classList.remove('hidden');
                navDashboardBtn.classList.add('active');
            } else if (viewId === 'accounts') {
                accountsView.classList.remove('hidden');
                navAccountsBtn.classList.add('active');
            } else if (viewId === 'settings') {
                settingsView.classList.remove('hidden');
                navSettingsBtn.classList.add('active');
                renderCurrencyRatesSettings(); // Populate currency rates when settings is opened
            }
        }


        // --- Firebase Initialization ---
        async function initializeFirebase() {
            showLoading();
            if (firebaseConfig && firebaseConfig.projectId) {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    console.log("Firebase initialized successfully.");

                    // Listen for auth state changes
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            currentUser = user;
                            userIdDisplay.textContent = currentUser.uid;
                            console.log("User authenticated:", currentUser.uid);
                            await loadInitialData(currentUser.uid);
                            showApp();
                        } else {
                            console.log("No user signed in. Showing auth view...");
                            currentUser = null; // Ensure currentUser is null if unauthenticated
                            showAuthView(); // Show the login/registration page
                        }
                    });

                } catch (error) {
                    console.error("Error initializing Firebase:", error);
                    showError("Failed to initialize Firebase. Check console for details.");
                }
            } else {
                showError("Firebase configuration is missing. Please ensure projectId is provided in the script.");
            }
        }

        // --- Data Fetching and Real-time Listeners ---
        async function loadInitialData(uid) {
            if (!db || !uid) {
                // This case should ideally not be hit if onAuthStateChanged works correctly
                showError("Database or User ID not available for data loading.");
                return;
            }

            // Assets listener
            const assetsCollectionRef = collection(db, `artifacts/${firebaseConfig.projectId}/users/${uid}/assets`);
            onSnapshot(assetsCollectionRef, (snapshot) => {
                assetsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAssetsTable();
                updateNetWorthSummary();
                renderAllocationChart();
                renderEquityDebtAllocationChart(); // New: Render equity/debt chart
            }, (err) => {
                console.error("Error fetching assets:", err);
                showError("Failed to load assets.");
            });

            // Transactions listener
            const transactionsCollectionRef = collection(db, `artifacts/${firebaseConfig.projectId}/users/${uid}/transactions`);
            onSnapshot(transactionsCollectionRef, (snapshot) => {
                transactionsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                transactionsData.sort((a, b) => b.timestamp - a.timestamp); // Sort descending
                renderTransactionsTable();
            }, (err) => {
                console.error("Error fetching transactions:", err);
                showError("Failed to load transactions.");
            });

            // Net Worth Snapshots listener
            const netWorthSnapshotsCollectionRef = collection(db, `artifacts/${firebaseConfig.projectId}/users/${uid}/netWorthSnapshots`);
            onSnapshot(netWorthSnapshotsCollectionRef, (snapshot) => {
                netWorthSnapshotsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                netWorthSnapshotsData.sort((a, b) => a.timestamp - b.timestamp); // Sort ascending for chart
                renderNetWorthChart(); // Re-render chart on data change
            }, (err) => {
                console.error("Error fetching net worth snapshots:", err);
                showError("Failed to load net worth history.");
            });

            // New: Custom Account Groups listener
            const customAccountGroupsCollectionRef = collection(db, `artifacts/${firebaseConfig.projectId}/users/${uid}/customAccountGroups`);
            onSnapshot(customAccountGroupsCollectionRef, (snapshot) => {
                customAccountGroupsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAccountGroupsList(); // Render the list in settings
                populateAccountGroupDropdowns(); // Update dropdowns in modals
            }, (err) => {
                console.error("Error fetching custom account groups:", err);
                showError("Failed to load custom account groups.");
            });

            // New: Currency Rates listener
            const currencyRatesDocRef = doc(db, `artifacts/${firebaseConfig.projectId}/users/${uid}/settings/currencyRates`);
            onSnapshot(currencyRatesDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const rates = docSnapshot.data();
                    EXCHANGE_RATES.USD_TO_INR = rates.USD_TO_INR || EXCHANGE_RATES.USD_TO_INR;
                    EXCHANGE_RATES.EUR_TO_INR = rates.EUR_TO_INR || EXCHANGE_RATES.EUR_TO_INR;
                    // Derive other rates if needed, or store them directly
                    EXCHANGE_RATES.INR_TO_USD = 1 / EXCHANGE_RATES.USD_TO_INR;
                    EXCHANGE_RATES.INR_TO_EUR = 1 / EXCHANGE_RATES.EUR_TO_INR;
                    EXCHANGE_RATES.USD_TO_EUR = EXCHANGE_RATES.USD_TO_INR / EXCHANGE_RATES.EUR_TO_INR;
                    EXCHANGE_RATES.EUR_TO_USD = EXCHANGE_RATES.EUR_TO_INR / EXCHANGE_RATES.USD_TO_INR;
                    console.log("Currency rates updated from Firestore:", EXCHANGE_RATES);
                } else {
                    console.log("No custom currency rates found, using defaults.");
                }
                // Re-render anything dependent on currency rates
                updateNetWorthSummary();
                renderAssetsTable();
                renderNetWorthChart();
                renderAllocationChart();
                renderEquityDebtAllocationChart();
                renderCurrencyRatesSettings(); // Update the input fields in settings
            }, (err) => {
                console.error("Error fetching currency rates:", err);
                showError("Failed to load currency rates.");
            });
        }

        // --- UI Rendering Functions ---
        function formatCurrency(value, currencyCode, includeDecimals = true) {
            return value.toLocaleString(undefined, {
                style: 'currency',
                currency: currencyCode,
                minimumFractionDigits: includeDecimals ? 2 : 0,
                maximumFractionDigits: includeDecimals ? 2 : 0
            });
        }

        function updateNetWorthSummary() {
            let total = 0;
            assetsData.forEach(asset => {
                total += convertCurrency(asset.value, asset.currency, primaryDisplayCurrency);
            });
            // Remove decimal points from total net worth
            totalNetWorthDisplay.textContent = formatCurrency(total, primaryDisplayCurrency, false);
            displayCurrencyAssets.textContent = primaryDisplayCurrency; // Update header
        }

        function renderAssetsTable() {
            assetsTableBody.innerHTML = ''; // Clear existing rows

            // Sort assets by group and then alphabetically within groups
            const sortedAssets = [...assetsData].sort((a, b) => {
                const groupA = a.group || 'Other';
                const groupB = b.group || 'Other';
                if (groupA < groupB) return -1;
                if (groupA > groupB) return 1;
                return a.name.localeCompare(b.name);
            });

            if (sortedAssets.length === 0) {
                noAssetsMessage.classList.remove('hidden');
                assetsTableContainer.classList.add('hidden');
            } else {
                noAssetsMessage.classList.add('hidden');
                assetsTableContainer.classList.remove('hidden');

                let currentGroup = null;
                let groupSubtotal = 0;

                sortedAssets.forEach((asset, index) => {
                    const assetGroup = asset.group || 'Other';

                    // Add sub-totals for each asset group
                    if (assetGroup !== currentGroup && currentGroup !== null) {
                        const subtotalRow = assetsTableBody.insertRow();
                        subtotalRow.className = 'bg-gray-100 font-semibold border-t-2 border-gray-300';
                        subtotalRow.innerHTML = `
                            <td class="py-2 px-4 whitespace-nowrap text-right" colspan="2">Total ${currentGroup}:</td>
                            <td class="py-2 px-4 whitespace-nowrap text-gray-800" colspan="3">
                                ${formatCurrency(groupSubtotal, primaryDisplayCurrency)}
                            </td>
                            <td class="py-2 px-4"></td>
                        `;
                        groupSubtotal = 0; // Reset subtotal for the new group
                    }
                    currentGroup = assetGroup;
                    groupSubtotal += convertCurrency(asset.value, asset.currency, primaryDisplayCurrency);


                    const row = assetsTableBody.insertRow();
                    // Apply alternating row colors
                    row.className = `hover:bg-gray-50 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`;
                    row.innerHTML = `
                        <td class="py-3 px-4 whitespace-nowrap text-gray-900">${asset.name}</td>
                        <td class="py-3 px-4 whitespace-nowrap text-gray-700">${asset.group}</td>
                        <td class="py-3 px-4 whitespace-nowrap text-gray-700">
                            ${formatCurrency(asset.value, asset.currency)}
                        </td>
                        <td class="py-3 px-4 whitespace-nowrap text-gray-700">
                            ${formatCurrency(convertCurrency(asset.value, asset.currency, primaryDisplayCurrency), primaryDisplayCurrency)}
                        </td>
                        <td class="py-3 px-4 whitespace-nowrap text-gray-700">
                            ${asset.equityPercentage !== undefined ? asset.equityPercentage + '%' : 'N/A'}
                        </td>
                        <td class="py-3 px-4 whitespace-nowrap text-gray-700">
                            ${new Date(asset.updatedAt).toLocaleString()}
                        </td>
                        <td class="py-3 px-4 whitespace-nowrap">
                            <div class="flex space-x-2">
                                <button data-id="${asset.id}" class="adjust-value-btn bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-full shadow-sm transition duration-200 ease-in-out transform hover:scale-110" title="Adjust Value">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"></path><path d="M5 12h14"></path></svg>
                                </button>
                                <button data-id="${asset.id}" class="edit-asset-btn bg-yellow-500 hover:bg-yellow-600 text-white p-2 rounded-full shadow-sm transition duration-200 ease-in-out transform hover:scale-110" title="Edit Asset">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                </button>
                                <button data-id="${asset.id}" class="delete-asset-btn bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-sm transition duration-200 ease-in-out transform hover:scale-110" title="Delete Asset">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </button>
                            </div>
                        </td>
                    `;
                    // Add event listeners to the new buttons
                    row.querySelector('.adjust-value-btn').addEventListener('click', (e) => openAdjustValueModal(e.currentTarget.dataset.id));
                    row.querySelector('.edit-asset-btn').addEventListener('click', (e) => openEditAssetModal(e.currentTarget.dataset.id));
                    row.querySelector('.delete-asset-btn').addEventListener('click', (e) => handleDeleteAsset(e.currentTarget.dataset.id));
                });

                // Add the last group's subtotal after the loop
                if (currentGroup !== null) {
                    const subtotalRow = assetsTableBody.insertRow();
                    subtotalRow.className = 'bg-gray-100 font-semibold border-t-2 border-gray-300';
                    subtotalRow.innerHTML = `
                        <td class="py-2 px-4 whitespace-nowrap text-right" colspan="2">Total ${currentGroup}:</td>
                        <td class="py-2 px-4 whitespace-nowrap text-gray-800" colspan="3">
                            ${formatCurrency(groupSubtotal, primaryDisplayCurrency)}
                        </td>
                        <td class="py-2 px-4"></td>
                    `;
                }
            }
        }

        function renderTransactionsTable() {
            transactionsTableBody.innerHTML = ''; // Clear existing rows
            if (transactionsData.length === 0) {
                noTransactionsMessage.classList.remove('hidden');
                transactionsTableContainer.classList.add('hidden');
            } else {
                noTransactionsMessage.classList.add('hidden');
                transactionsTableContainer.classList.remove('hidden');
                transactionsData.forEach((tx, index) => {
                    const row = transactionsTableBody.insertRow();
                    // Apply alternating row colors
                    row.className = `hover:bg-gray-50 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`;
                    const assetCurrency = assetsData.find(a => a.id === tx.assetId)?.currency || primaryDisplayCurrency;
                    const amountChangedClass = tx.amountChanged >= 0 ? 'text-green-600' : 'text-red-600';
                    const typeText = tx.type === 'add' ? 'Add' : tx.type === 'subtract' ? 'Subtract' : 'Update';
                    const typeClass = tx.type === 'add' ? 'text-green-600' : tx.type === 'subtract' ? 'text-red-600' : 'text-blue-600';

                    row.innerHTML = `
                        <td class="py-3 px-4 whitespace-nowrap text-gray-900">
                            ${new Date(tx.timestamp).toLocaleString()}
                        </td>
                        <td class="py-3 px-4 whitespace-nowrap text-gray-700">${tx.assetName}</td>
                        <td class="py-3 px-4 whitespace-nowrap text-gray-700">
                            <span class="font-semibold ${typeClass}">${typeText}</span>
                        </td>
                        <td class="py-3 px-4 whitespace-nowrap ${amountChangedClass}">
                            ${formatCurrency(tx.amountChanged, assetCurrency)}
                        </td>
                        <td class="py-3 px-4 whitespace-nowrap text-gray-700">
                            ${formatCurrency(tx.newValue, assetCurrency)}
                        </td>
                        <td class="py-3 px-4 text-gray-700">${tx.description}</td>
                    `;
                });
            }
        }

        /**
         * Aggregates net worth snapshots based on the selected period.
         * @param {Array<Object>} snapshots - Array of net worth snapshot objects.
         * @param {string} period - Aggregation period ('daily', 'monthly', 'quarterly', 'yearly').
         * @returns {{labels: Array<string>, data: Array<number>}} Aggregated labels and data.
         */
        function getAggregatedNetWorthData(snapshots, period) {
            if (snapshots.length === 0) {
                return { labels: [], data: [] };
            }

            const aggregatedMap = new Map(); // Key: formatted date string, Value: latest snapshot value

            snapshots.forEach(snapshot => {
                const date = new Date(snapshot.timestamp);
                let key;

                switch (period) {
                    case 'monthly':
                        key = date.toLocaleString('default', { month: 'short', year: 'numeric' }); // e.g., "Jul 2025"
                        break;
                    case 'quarterly':
                        const quarter = Math.floor(date.getMonth() / 3) + 1;
                        key = `Q${quarter} ${date.getFullYear()}`; // e.g., "Q3 2025"
                        break;
                    case 'yearly':
                        key = date.getFullYear().toString(); // e.g., "2025"
                        break;
                    default: // Fallback to monthly if an unexpected value is passed
                        key = date.toLocaleString('default', { month: 'short', year: 'numeric' });
                }

                // Always store the latest snapshot for a given period key
                // This assumes snapshots are sorted by timestamp, which they are.
                aggregatedMap.set(key, snapshot.totalNetWorth);
            });

            // Convert map to arrays, preserving insertion order for Chart.js
            const labels = Array.from(aggregatedMap.keys());
            const data = Array.from(aggregatedMap.values());

            return { labels, data };
        }


        function renderNetWorthChart() {
            // Get aggregated data based on current selection
            const { labels, data } = getAggregatedNetWorthData(netWorthSnapshotsData, currentChartAggregation);

            if (labels.length < 2) {
                noHistoryMessage.classList.remove('hidden');
                netWorthChartContainer.classList.add('hidden');
                if (netWorthChartInstance) {
                    netWorthChartInstance.destroy();
                    netWorthChartInstance = null;
                }
                return;
            } else {
                noHistoryMessage.classList.add('hidden');
                netWorthChartContainer.classList.remove('hidden');
            }

            if (netWorthChartInstance) {
                netWorthChartInstance.data.labels = labels;
                netWorthChartInstance.data.datasets[0].data = data;
                netWorthChartInstance.data.datasets[0].label = `Net Worth (${primaryDisplayCurrency})`;
                netWorthChartInstance.update();
            } else {
                netWorthChartInstance = new Chart(netWorthChartCanvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Net Worth (${primaryDisplayCurrency})`,
                            data: data,
                            borderColor: '#8884d8',
                            tension: 0.1,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true, // Vertical Axis starts from zero
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value, primaryDisplayCurrency, false); // Remove decimal points
                                    }
                                }
                            },
                            x: {
                                // For time series, consider 'time' scale type if more precise date handling is needed,
                                // but for aggregated data, 'category' or 'linear' with formatted labels is fine.
                                // The current setup with formatted string labels works well for discrete aggregated points.
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${formatCurrency(context.raw, primaryDisplayCurrency, false)}`; // Tooltip also without decimals
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function renderAllocationChart() {
            const allocation = {};
            assetsData.forEach(asset => {
                const valueInPrimary = convertCurrency(asset.value, asset.currency, primaryDisplayCurrency);
                allocation[asset.group] = (allocation[asset.group] || 0) + valueInPrimary;
            });

            const allocationData = Object.keys(allocation).map(group => ({
                name: group,
                value: allocation[group]
            }));

            if (allocationData.length === 0 || allocationData.every(d => d.value === 0)) {
                noAllocationMessage.classList.remove('hidden');
                allocationChartContainer.classList.add('hidden');
                if (allocationChartInstance) {
                    allocationChartInstance.destroy();
                    allocationChartInstance = null;
                }
                return;
            } else {
                noAllocationMessage.classList.add('hidden');
                allocationChartContainer.classList.remove('hidden');
            }

            const labels = allocationData.map(d => d.name);
            const data = allocationData.map(d => d.value);
            const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#AF19FF', '#FF19A3'];

            if (allocationChartInstance) {
                allocationChartInstance.data.labels = labels;
                allocationChartInstance.data.datasets[0].data = data;
                allocationChartInstance.data.datasets[0].backgroundColor = labels.map((_, i) => COLORS[i % COLORS.length]);
                allocationChartInstance.update();
            } else {
                allocationChartInstance = new Chart(assetAllocationChartCanvas, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: labels.map((_, i) => COLORS[i % COLORS.length]),
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let sum = 0;
                                        let dataArr = context.dataset.data;
                                        for (let i = 0; i < dataArr.length; i++) {
                                            sum += dataArr[i];
                                        }
                                        let percentage = (context.raw * 100 / sum).toFixed(0) + '%';
                                        return `${context.label}: ${formatCurrency(context.raw, primaryDisplayCurrency)} (${percentage})`;
                                    }
                                }
                            },
                            legend: {
                                position: 'right',
                            }
                        }
                    }
                });
            }
        }

        // New: Render Equity vs. Non-Equity Allocation Chart
        function renderEquityDebtAllocationChart() {
            let totalEquity = 0;
            let totalNonEquity = 0;

            assetsData.forEach(asset => {
                const valueInPrimary = convertCurrency(asset.value, asset.currency, primaryDisplayCurrency);
                const equityPercentage = asset.equityPercentage !== undefined ? parseFloat(asset.equityPercentage) : 0;

                if (!isNaN(equityPercentage) && equityPercentage >= 0 && equityPercentage <= 100) {
                    totalEquity += valueInPrimary * (equityPercentage / 100);
                    totalNonEquity += valueInPrimary * (1 - (equityPercentage / 100));
                } else {
                    // If equityPercentage is invalid or not set, consider it non-equity by default
                    totalNonEquity += valueInPrimary;
                }
            });

            const equityData = [
                { name: 'Equity', value: totalEquity },
                { name: 'Non-Equity', value: totalNonEquity }
            ];

            // Filter out categories with zero value for cleaner chart
            const filteredEquityData = equityData.filter(d => d.value > 0);

            if (filteredEquityData.length === 0) {
                noEquityAllocationMessage.classList.remove('hidden');
                equityAllocationChartContainer.classList.add('hidden');
                if (equityAllocationChartInstance) {
                    equityAllocationChartInstance.destroy();
                    equityAllocationChartInstance = null;
                }
                return;
            } else {
                noEquityAllocationMessage.classList.add('hidden');
                equityAllocationChartContainer.classList.remove('hidden');
            }

            const labels = filteredEquityData.map(d => d.name);
            const data = filteredEquityData.map(d => d.value);
            const COLORS = ['#4CAF50', '#FFC107']; // Green for Equity, Amber for Non-Equity

            if (equityAllocationChartInstance) {
                equityAllocationChartInstance.data.labels = labels;
                equityAllocationChartInstance.data.datasets[0].data = data;
                equityAllocationChartInstance.data.datasets[0].backgroundColor = labels.map((_, i) => COLORS[i % COLORS.length]);
                equityAllocationChartInstance.update();
            } else {
                equityAllocationChartInstance = new Chart(equityAllocationChartCanvas, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: COLORS,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let sum = 0;
                                        let dataArr = context.dataset.data;
                                        for (let i = 0; i < dataArr.length; i++) {
                                            sum += dataArr[i];
                                        }
                                        let percentage = (context.raw * 100 / sum).toFixed(0) + '%';
                                        return `${context.label}: ${formatCurrency(context.raw, primaryDisplayCurrency)} (${percentage})`;
                                    }
                                }
                            },
                            legend: {
                                position: 'right',
                            }
                        }
                    }
                });
            }
        }


        // New: Render custom account groups list in settings
        function renderAccountGroupsList() {
            accountGroupsTableBody.innerHTML = ''; // Clear existing rows
            if (customAccountGroupsData.length === 0) {
                noGroupsMessage.classList.remove('hidden');
                accountGroupsTable.classList.add('hidden');
            } else {
                noGroupsMessage.classList.add('hidden');
                accountGroupsTable.classList.remove('hidden');
                customAccountGroupsData.forEach((group, index) => {
                    const row = accountGroupsTableBody.insertRow();
                    // Apply alternating row colors
                    row.className = `hover:bg-gray-50 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`;
                    row.innerHTML = `
                        <td class="py-2 px-4 text-gray-900">${group.name}</td>
                        <td class="py-2 px-4">
                            <button data-id="${group.id}" data-name="${group.name}" class="edit-group-btn bg-yellow-500 hover:bg-yellow-600 text-white p-1 rounded-full text-xs shadow-sm mr-2" title="Edit Group">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            </button>
                            <button data-id="${group.id}" class="delete-group-btn bg-red-500 hover:bg-red-600 text-white p-1 rounded-full text-xs shadow-sm" title="Delete Group">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </td>
                    `;
                    row.querySelector('.edit-group-btn').addEventListener('click', (e) => openEditGroupModal(e.currentTarget.dataset.id, e.currentTarget.dataset.name));
                    row.querySelector('.delete-group-btn').addEventListener('click', (e) => handleDeleteGroup(e.currentTarget.dataset.id, e.currentTarget.dataset.name));
                });
            }
        }

        // New: Populate account group dropdowns in Add/Edit Asset modals
        function populateAccountGroupDropdowns() {
            // Clear existing options, except the "Select a group" one
            newAssetGroupSelect.innerHTML = '<option value="">Select a group (Optional)</option>';
            editAssetGroupSelect.innerHTML = '<option value="">Select a group (Optional)</option>';

            // Default groups
            const defaultGroups = ["Banks", "Brokerage Accounts", "Mutual Funds", "Immovable assets", "Other"];

            // Combine default and custom groups, ensuring uniqueness and sorting
            const allGroups = [...new Set([...defaultGroups, ...customAccountGroupsData.map(g => g.name)])].sort();

            allGroups.forEach(groupName => {
                const option1 = document.createElement('option');
                option1.value = groupName;
                option1.textContent = groupName;
                newAssetGroupSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = groupName;
                option2.textContent = groupName;
                editAssetGroupSelect.appendChild(option2);
            });
        }

        // New: Render currency rates in settings
        function renderCurrencyRatesSettings() {
            usdToInrRateInput.value = EXCHANGE_RATES.USD_TO_INR.toFixed(2);
            eurToInrRateInput.value = EXCHANGE_RATES.EUR_TO_INR.toFixed(2);
            usdCurrencyDisplay.textContent = primaryDisplayCurrency;
            eurCurrencyDisplay.textContent = primaryDisplayCurrency;
            currencyRateError.classList.add('hidden'); // Hide any previous error
        }

        // New: Handle saving currency rates
        async function handleSaveCurrencyRates() {
            if (!currentUser || !db) {
                currencyRateError.textContent = "User not authenticated or database not ready.";
                currencyRateError.classList.remove('hidden');
                return;
            }

            const usdRate = parseFloat(usdToInrRateInput.value);
            const eurRate = parseFloat(eurToInrRateInput.value);

            if (isNaN(usdRate) || usdRate <= 0 || isNaN(eurRate) || eurRate <= 0) {
                currencyRateError.textContent = "Please enter valid positive numbers for exchange rates.";
                currencyRateError.classList.remove('hidden');
                return;
            }

            try {
                const currencyRatesDocRef = doc(db, `artifacts/${firebaseConfig.projectId}/users/${currentUser.uid}/settings/currencyRates`);
                await setDoc(currencyRatesDocRef, {
                    USD_TO_INR: usdRate,
                    EUR_TO_INR: eurRate,
                    updatedAt: Date.now()
                });
                currencyRateError.textContent = "Currency rates saved successfully!";
                currencyRateError.classList.remove('hidden', 'text-red-500');
                currencyRateError.classList.add('text-green-500');
                // Rates will be reloaded via onSnapshot and UI updated
            } catch (err) {
                console.error("Error saving currency rates:", err);
                currencyRateError.textContent = "Failed to save rates: " + err.message;
                currencyRateError.classList.remove('hidden', 'text-green-500');
                currencyRateError.classList.add('text-red-500');
            }
        }


        // --- Modal Functions ---
        function openAddAssetModal() {
            newAssetNameInput.value = '';
            newAssetValueInput.value = '';
            newAssetCurrencySelect.value = 'INR';
            newAssetGroupSelect.value = ''; // Reset to default
            newAssetEquityPercentageInput.value = '100'; // Default to 100% equity
            populateAccountGroupDropdowns(); // Ensure dropdown is up-to-date
            showModal(addAssetModal, addAssetError);
        }

        function closeAddAssetModal() {
            hideModal(addAssetModal, addAssetError);
        }

        function openAdjustValueModal(assetId) {
            selectedAssetForAdjustment = assetsData.find(asset => asset.id === assetId);
            if (selectedAssetForAdjustment) {
                adjustAssetNameSpan.textContent = selectedAssetForAdjustment.name;
                adjustAssetCurrencySpan.textContent = selectedAssetForAdjustment.currency;
                adjustCurrentValueSpan.textContent = formatCurrency(selectedAssetForAdjustment.value, selectedAssetForAdjustment.currency);
                transactionAmountInput.value = '';
                transactionAbsoluteValueInput.value = '';
                transactionDescriptionInput.value = '';
                // Reset radio buttons to 'add' and show amount section
                document.querySelector('input[name="transactionType"]:checked').checked = false; // Uncheck all
                document.querySelector('input[name="transactionType"][value="add"]').checked = true; // Check 'add'
                transactionAmountSection.classList.remove('hidden');
                transactionAbsoluteValueSection.classList.add('hidden');
                showModal(adjustValueModal, adjustValueError);
            } else {
                console.error("Asset not found for adjustment:", assetId);
                showError("Asset not found for adjustment.");
            }
        }

        function closeAdjustValueModal() {
            hideModal(adjustValueModal, adjustValueError);
            selectedAssetForAdjustment = null;
        }

        function openEditAssetModal(assetId) {
            currentEditAssetId = assetId;
            const assetToEdit = assetsData.find(asset => asset.id === assetId);
            if (assetToEdit) {
                editAssetNameInput.value = assetToEdit.name;
                populateAccountGroupDropdowns(); // Ensure dropdown is up-to-date
                editAssetGroupSelect.value = assetToEdit.group || ''; // Set current group
                editAssetEquityPercentageInput.value = assetToEdit.equityPercentage !== undefined ? assetToEdit.equityPercentage : '100'; // Set current equity % or default
                showModal(editAssetModal, editAssetError);
            } else {
                console.error("Asset not found for editing:", assetId);
                showError("Asset not found for editing.");
            }
        }

        function closeEditAssetModal() {
            hideModal(editAssetModal, editAssetError);
            currentEditAssetId = null;
        }

        function openEditGroupModal(groupId, groupName) {
            currentEditGroupId = groupId;
            editGroupNameInput.value = groupName;
            showModal(editGroupModal, editGroupError);
        }

        function closeEditGroupModal() {
            hideModal(editGroupModal, editGroupError);
            currentEditGroupId = null;
            editGroupNameInput.value = '';
        }


        // --- Authentication Handlers ---
        function toggleAuthMode() {
            isSignInMode = !isSignInMode;
            if (isSignInMode) {
                authFormTitle.textContent = 'Sign In';
                signInBtn.classList.remove('hidden');
                signUpBtn.classList.add('hidden');
                toggleAuthModeBtn.textContent = 'Switch to Sign Up';
            } else {
                authFormTitle.textContent = 'Sign Up';
                signInBtn.classList.add('hidden');
                signUpBtn.classList.remove('hidden');
                toggleAuthModeBtn.textContent = 'Switch to Sign In';
            }
            authErrorMessage.classList.add('hidden'); // Clear error on mode switch
            authEmailInput.value = '';
            authPasswordInput.value = '';
        }

        async function handleSignIn() {
            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value.trim();
            if (!email || !password) {
                authErrorMessage.textContent = "Please enter both email and password.";
                authErrorMessage.classList.remove('hidden');
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle showing the main app
            } catch (error) {
                console.error("Sign In Error:", error);
                authErrorMessage.textContent = error.message;
                authErrorMessage.classList.remove('hidden');
            }
        }

        async function handleSignUp() {
            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value.trim();
            if (!email || !password) {
                authErrorMessage.textContent = "Please enter both email and password.";
                authErrorMessage.classList.remove('hidden');
                return;
            }
            if (password.length < 6) {
                authErrorMessage.textContent = "Password should be at least 6 characters.";
                authErrorMessage.classList.remove('hidden');
                return;
            }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle showing the main app
            } catch (error) {
                console.error("Sign Up Error:", error);
                authErrorMessage.textContent = error.message;
                authErrorMessage.classList.remove('hidden');
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
                // onAuthStateChanged will handle showing the auth view
            } catch (error) {
                console.error("Sign Out Error:", error);
                showError("Failed to sign out: " + error.message);
            }
        }


        // --- Event Handlers for App Functionality ---
        async function handleAddAssetSubmit() {
            if (!currentUser || !db) {
                addAssetError.textContent = "User not authenticated or database not ready.";
                addAssetError.classList.remove('hidden');
                return;
            }
            const name = newAssetNameInput.value.trim();
            const value = parseFloat(newAssetValueInput.value);
            const currency = newAssetCurrencySelect.value;
            const group = newAssetGroupSelect.value || 'Other';
            const equityPercentage = parseFloat(newAssetEquityPercentageInput.value);


            if (!name || isNaN(value) || value <= 0) {
                addAssetError.textContent = "Please enter a valid asset name and a positive numeric value.";
                addAssetError.classList.remove('hidden');
                return;
            }
            if (isNaN(equityPercentage) || equityPercentage < 0 || equityPercentage > 100) {
                addAssetError.textContent = "Equity % must be a number between 0 and 100.";
                addAssetError.classList.remove('hidden');
                return;
            }


            try {
                const assetsCollectionRef = collection(db, `artifacts/${firebaseConfig.projectId}/users/${currentUser.uid}/assets`);
                await addDoc(assetsCollectionRef, {
                    name: name,
                    value: value,
                    currency: currency,
                    group: group,
                    equityPercentage: equityPercentage, // Save equity percentage
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                });
                closeAddAssetModal();
            } catch (err) {
                console.error("Error adding asset:", err);
                addAssetError.textContent = "Failed to add asset: " + err.message;
                addAssetError.classList.remove('hidden');
            }
        }

        async function handleUpdateAssetValue() {
            if (!currentUser || !db || !selectedAssetForAdjustment) {
                adjustValueError.textContent = "User not authenticated, database not ready, or no asset selected.";
                adjustValueError.classList.remove('hidden');
                return;
            }

            let newValue;
            let amountChanged;
            let transactionDescriptionText = transactionDescriptionInput.value.trim();
            let transactionType = document.querySelector('input[name="transactionType"]:checked').value;

            if (transactionType === 'absolute') {
                const absoluteVal = parseFloat(transactionAbsoluteValueInput.value);
                if (isNaN(absoluteVal) || absoluteVal < 0) {
                    adjustValueError.textContent = "Please enter a valid non-negative absolute value.";
                    adjustValueError.classList.remove('hidden');
                    return;
                }
                amountChanged = absoluteVal - selectedAssetForAdjustment.value;
                newValue = absoluteVal;
                transactionDescriptionText = transactionDescriptionText || `Updated to absolute value ${formatCurrency(absoluteVal, selectedAssetForAdjustment.currency)}`;
            } else {
                const amount = parseFloat(transactionAmountInput.value);
                if (isNaN(amount) || amount <= 0) {
                    adjustValueError.textContent = "Please enter a valid positive amount for the transaction.";
                    adjustValueError.classList.remove('hidden');
                    return;
                }

                if (transactionType === 'add') {
                    newValue = selectedAssetForAdjustment.value + amount;
                    amountChanged = amount;
                    transactionDescriptionText = transactionDescriptionText || `Added ${formatCurrency(amount, selectedAssetForAdjustment.currency)} to ${selectedAssetForAdjustment.name}`;
                } else { // subtract
                    newValue = selectedAssetForAdjustment.value - amount;
                    amountChanged = -amount;
                    transactionDescriptionText = transactionDescriptionText || `Subtracted ${formatCurrency(amount, selectedAssetForAdjustment.currency)} from ${selectedAssetForAdjustment.name}`;
                }

                if (newValue < 0) {
                    adjustValueError.textContent = "Asset value cannot go below zero.";
                    adjustValueError.classList.remove('hidden');
                    return;
                }
            }

            try {
                const assetDocRef = doc(db, `artifacts/${firebaseConfig.projectId}/users/${currentUser.uid}/assets`, selectedAssetForAdjustment.id);
                await updateDoc(assetDocRef, {
                    value: newValue,
                    updatedAt: Date.now()
                });

                // Record transaction
                const transactionsCollectionRef = collection(db, `artifacts/${firebaseConfig.projectId}/users/${currentUser.uid}/transactions`);
                await addDoc(transactionsCollectionRef, {
                    assetId: selectedAssetForAdjustment.id,
                    assetName: selectedAssetForAdjustment.name,
                    oldValue: selectedAssetForAdjustment.value,
                    newValue: newValue,
                    amountChanged: amountChanged,
                    type: transactionType,
                    description: transactionDescriptionText,
                    timestamp: Date.now()
                });

                closeAdjustValueModal();
            } catch (err) {
                console.error("Error updating asset value or recording transaction:", err);
                adjustValueError.textContent = "Failed to update asset value or record transaction: " + err.message;
                adjustValueError.classList.remove('hidden');
            }
        }

        async function handleEditAssetSubmit() {
            if (!currentUser || !db || !currentEditAssetId) {
                editAssetError.textContent = "User not authenticated or database not ready.";
                editAssetError.classList.remove('hidden');
                return;
            }
            const name = editAssetNameInput.value.trim();
            const group = editAssetGroupSelect.value || 'Other';
            const equityPercentage = parseFloat(editAssetEquityPercentageInput.value);

            if (!name) {
                editAssetError.textContent = "Asset name cannot be empty.";
                editAssetError.classList.remove('hidden');
                return;
            }
            if (isNaN(equityPercentage) || equityPercentage < 0 || equityPercentage > 100) {
                editAssetError.textContent = "Equity % must be a number between 0 and 100.";
                editAssetError.classList.remove('hidden');
                return;
            }

            try {
                const assetDocRef = doc(db, `artifacts/${firebaseConfig.projectId}/users/${currentUser.uid}/assets`, currentEditAssetId);
                await updateDoc(assetDocRef, {
                    name: name,
                    group: group,
                    equityPercentage: equityPercentage, // Update equity percentage
                    updatedAt: Date.now()
                });
                closeEditAssetModal();
            } catch (err) {
                console.error("Error editing asset:", err);
                editAssetError.textContent = "Failed to edit asset: " + err.message;
                editAssetError.classList.remove('hidden');
            }
        }

        async function handleDeleteAsset(assetId) {
            if (!currentUser || !db) {
                showError("User not authenticated or database not ready.");
                return;
            }
            if (!confirm("Are you sure you want to delete this asset and all its associated transactions?")) {
                return;
            }

            try {
                // Delete asset document
                await deleteDoc(doc(db, `artifacts/${firebaseConfig.projectId}/users/${currentUser.uid}/assets`, assetId));

                // Delete associated transactions
                const transactionsRef = collection(db, `artifacts/${firebaseConfig.projectId}/users/${currentUser.uid}/transactions`);
                const q = query(transactionsRef, where("assetId", "==", assetId));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(async (doc) => {
                    await deleteDoc(doc.ref);
                });
            } catch (err) {
                console.error("Error deleting asset:", err);
                showError("Failed to delete asset: " + err.message);
            }
        }

        async function handleTakeSnapshot() {
            if (!currentUser || !db) {
                showError("User not authenticated or database not ready.");
                return;
            }
            try {
                let total = 0;
                assetsData.forEach(asset => {
                    total += convertCurrency(asset.value, asset.currency, primaryDisplayCurrency);
                });

                const snapshotsCollectionRef = collection(db, `artifacts/${firebaseConfig.projectId}/users/${currentUser.uid}/netWorthSnapshots`);
                await addDoc(snapshotsCollectionRef, {
                    totalNetWorth: total,
                    currency: primaryDisplayCurrency,
                    timestamp: Date.now()
                });
            } catch (err) {
                console.error("Error taking net worth snapshot:", err);
                showError("Failed to take net worth snapshot: " + err.message);
            }
        }

        // CSV Export Function for Assets
        function exportAssetsToCSV() {
            if (assetsData.length === 0) {
                alert("No assets to export."); // Using alert for simplicity, replace with custom modal if needed.
                return;
            }

            const headers = ["Asset Name", "Group", "Value", "Currency", "Value (Primary Currency)", "Equity %", "Last Updated"];
            const rows = assetsData.map(asset => {
                const valueInPrimary = convertCurrency(asset.value, asset.currency, primaryDisplayCurrency);
                return [
                    `"${asset.name.replace(/"/g, '""')}"`, // Handle commas and quotes in name
                    `"${(asset.group || 'Other').replace(/"/g, '""')}"`,
                    asset.value.toFixed(2),
                    asset.currency,
                    valueInPrimary.toFixed(2),
                    asset.equityPercentage !== undefined ? asset.equityPercentage : '', // Export equity percentage
                    new Date(asset.updatedAt).toLocaleString()
                ];
            });

            const csvContent = [
                headers.join(","),
                ...rows.map(row => row.join(","))
            ].join("\n");

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { // Feature detection for download attribute
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `net_worth_assets_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                // Fallback for browsers that don't support download attribute
                alert("Your browser does not support downloading files directly. Please copy the content below:\n\n" + csvContent);
            }
        }

        // CSV Export Function for Net Worth History
        function exportHistoryToCSV() {
            if (netWorthSnapshotsData.length === 0) {
                alert("No net worth history to export.");
                return;
            }

            const headers = ["Date", "Total Net Worth", "Currency"];
            const rows = netWorthSnapshotsData.map(snapshot => {
                // Format date consistently for CSV (YYYY-MM-DD HH:MM:SS)
                const date = new Date(snapshot.timestamp);
                const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
                return [
                    `"${formattedDate}"`, // Enclose date in quotes to handle spaces
                    snapshot.totalNetWorth.toFixed(2),
                    snapshot.currency
                ];
            });

            const csvContent = [
                headers.join(","),
                ...rows.map(row => row.join(","))
            ].join("\n");

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `net_worth_history_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert("Your browser does not support downloading files directly. Please copy the content below:\n\n" + csvContent);
            }
        }

        // CSV Upload Function for Net Worth History
        async function uploadHistoryFromCSV() {
            if (!currentUser || !db) {
                historyCsvMessage.textContent = "User not authenticated or database not ready.";
                historyCsvMessage.classList.remove('hidden');
                return;
            }

            const file = csvUploadInput.files[0];
            if (!file) {
                historyCsvMessage.textContent = "Please select a CSV file to upload.";
                historyCsvMessage.classList.remove('hidden');
                historyCsvMessage.classList.add('text-red-500');
                return;
            }

            historyCsvMessage.classList.add('hidden'); // Hide previous errors
            historyCsvMessage.textContent = "Uploading and processing...";
            historyCsvMessage.classList.remove('hidden', 'text-red-500', 'text-green-500');
            historyCsvMessage.classList.add('text-blue-500'); // Indicate processing

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim() !== '');
                if (lines.length <= 1) { // Headers + at least one data row
                    historyCsvMessage.textContent = "CSV file is empty or contains only headers.";
                    historyCsvMessage.classList.remove('text-blue-500');
                    historyCsvMessage.classList.add('text-red-500');
                    return;
                }

                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const expectedHeaders = ["Date", "Total Net Worth", "Currency"];
                // Check if headers match exactly
                if (headers.length !== expectedHeaders.length || !expectedHeaders.every((val, index) => val === headers[index])) {
                    historyCsvMessage.textContent = "CSV headers do not match expected format: 'Date,Total Net Worth,Currency'. Please ensure exact matching, including order.";
                    historyCsvMessage.classList.remove('text-blue-500');
                    historyCsvMessage.classList.add('text-red-500');
                    return;
                }

                const dataRows = lines.slice(1);
                let successfulUploads = 0;
                let failedRows = [];

                for (let i = 0; i < dataRows.length; i++) {
                    const row = dataRows[i];
                    const columns = row.split(',').map(c => c.trim().replace(/"/g, ''));

                    if (columns.length !== expectedHeaders.length) {
                        failedRows.push(`Row ${i + 2}: Incorrect number of columns.`);
                        continue;
                    }

                    const dateString = columns[0]; // Date is at index 0
                    const totalNetWorthStr = columns[1]; // Total Net Worth is at index 1
                    const currency = columns[2]; // Currency is at index 2

                    const timestamp = new Date(dateString).getTime();
                    const totalNetWorth = parseFloat(totalNetWorthStr);

                    if (isNaN(timestamp) || isNaN(totalNetWorth) || totalNetWorth < 0 || !['INR', 'USD', 'EUR'].includes(currency)) {
                        failedRows.push(`Row ${i + 2}: Invalid data (Date, Net Worth, or Currency format).`);
                        continue;
                    }

                    try {
                        const snapshotsCollectionRef = collection(db, `artifacts/${firebaseConfig.projectId}/users/${currentUser.uid}/netWorthSnapshots`);
                        await addDoc(snapshotsCollectionRef, {
                            totalNetWorth: totalNetWorth,
                            currency: currency,
                            timestamp: timestamp
                        });
                        successfulUploads++;
                    } catch (err) {
                        console.error("Error adding historical snapshot from CSV:", err);
                        failedRows.push(`Row ${i + 2}: Database error - ${err.message}`);
                    }
                }

                if (successfulUploads > 0) {
                    historyCsvMessage.textContent = `Successfully imported ${successfulUploads} historical snapshots.`;
                    historyCsvMessage.classList.remove('text-red-500', 'text-blue-500');
                    historyCsvMessage.classList.add('text-green-500');
                } else {
                    historyCsvMessage.textContent = "No valid historical snapshots were imported.";
                    historyCsvMessage.classList.remove('text-blue-500');
                    historyCsvMessage.classList.add('text-red-500');
                }
                if (failedRows.length > 0) {
                    historyCsvMessage.textContent += ` (Errors in ${failedRows.length} rows: ${failedRows.join('; ')})`;
                }
                csvUploadInput.value = ''; // Clear file input
            };
            reader.onerror = () => {
                historyCsvMessage.textContent = "Failed to read file.";
                historyCsvMessage.classList.remove('text-blue-500');
                historyCsvMessage.classList.add('text-red-500');
            };
            reader.readAsText(file);
        }

        // New: Account Group Management Handlers
        async function handleAddGroup() {
            if (!currentUser || !db) {
                accountGroupError.textContent = "User not authenticated or database not ready.";
                accountGroupError.classList.remove('hidden');
                return;
            }
            const groupName = newGroupNameInput.value.trim();
            if (!groupName) {
                accountGroupError.textContent = "Group name cannot be empty.";
                accountGroupError.classList.remove('hidden');
                return;
            }

            // Check for duplicate group names (case-insensitive)
            const isDuplicate = customAccountGroupsData.some(group => group.name.toLowerCase() === groupName.toLowerCase());
            if (isDuplicate) {
                accountGroupError.textContent = "Group with this name already exists.";
                accountGroupError.classList.remove('hidden');
                return;
            }

            try {
                const groupsCollectionRef = collection(db, `artifacts/${firebaseConfig.projectId}/users/${currentUser.uid}/customAccountGroups`);
                await addDoc(groupsCollectionRef, {
                    name: groupName,
                    createdAt: Date.now()
                });
                newGroupNameInput.value = '';
                accountGroupError.classList.add('hidden');
            } catch (err) {
                console.error("Error adding group:", err);
                accountGroupError.textContent = "Failed to add group: " + err.message;
                accountGroupError.classList.remove('hidden');
            }
        }

        async function handleEditGroupSubmit() {
            if (!currentUser || !db || !currentEditGroupId) {
                editGroupError.textContent = "User not authenticated or database not ready.";
                editGroupError.classList.remove('hidden');
                return;
            }
            const newName = editGroupNameInput.value.trim();
            if (!newName) {
                editGroupError.textContent = "Group name cannot be empty.";
                editGroupError.classList.remove('hidden');
                return;
            }

            // Check for duplicate group names (excluding the current group being edited)
            const isDuplicate = customAccountGroupsData.some(group =>
                group.id !== currentEditGroupId && group.name.toLowerCase() === newName.toLowerCase()
            );
            if (isDuplicate) {
                editGroupError.textContent = "Another group with this name already exists.";
                editGroupError.classList.remove('hidden');
                return;
            }

            try {
                const groupDocRef = doc(db, `artifacts/${firebaseConfig.projectId}/users/${currentUser.uid}/customAccountGroups`, currentEditGroupId);
                await updateDoc(groupDocRef, {
                    name: newName
                });
                closeEditGroupModal();
            } catch (err) {
                console.error("Error editing group:", err);
                editGroupError.textContent = "Failed to edit group: " + err.message;
                editGroupError.classList.remove('hidden');
            }
        }

        async function handleDeleteGroup(groupId, groupName) {
            if (!currentUser || !db) {
                showError("User not authenticated or database not ready.");
                return;
            }
            if (!confirm(`Are you sure you want to delete the group "${groupName}"? Assets assigned to this group will revert to "Other".`)) {
                return;
            }

            try {
                // Delete the group document
                await deleteDoc(doc(db, `artifacts/${firebaseConfig.projectId}/users/${currentUser.uid}/customAccountGroups`, groupId));

                // Update any assets that belong to this group to 'Other'
                const assetsRef = collection(db, `artifacts/${firebaseConfig.projectId}/users/${currentUser.uid}/assets`);
                const q = query(assetsRef, where("group", "==", groupName));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(async (assetDoc) => {
                    await updateDoc(assetDoc.ref, { group: 'Other' });
                });
            } catch (err) {
                console.error("Error deleting group:", err);
                showError("Failed to delete group: " + err.message);
            }
        }


        // --- Event Listeners Setup ---
        document.addEventListener('DOMContentLoaded', initializeFirebase);

        // Authentication listeners
        toggleAuthModeBtn.addEventListener('click', toggleAuthMode);
        signInBtn.addEventListener('click', handleSignIn);
        signUpBtn.addEventListener('click', handleSignUp);
        signOutBtn.addEventListener('click', handleSignOut); // Sign out button listener

        // Navigation listeners
        navDashboardBtn.addEventListener('click', () => renderActiveView('dashboard'));
        navAccountsBtn.addEventListener('click', () => renderActiveView('accounts'));
        navSettingsBtn.addEventListener('click', () => renderActiveView('settings'));


        currencySelect.addEventListener('change', (e) => {
            primaryDisplayCurrency = e.target.value;
            updateNetWorthSummary();
            renderAssetsTable(); // Re-render to update converted values
            renderNetWorthChart();
            renderAllocationChart();
            renderEquityDebtAllocationChart(); // Re-render equity/debt chart
            // No need to call renderCurrencyRatesSettings here, as it's called when navigating to settings
            // and onSnapshot for currency rates will trigger updates.
        });

        takeSnapshotBtn.addEventListener('click', handleTakeSnapshot);

        // Asset management buttons (now in Accounts view)
        addAssetBtn.addEventListener('click', openAddAssetModal);
        exportCsvBtn.addEventListener('click', exportAssetsToCSV);

        // Modals buttons
        saveNewAssetBtn.addEventListener('click', handleAddAssetSubmit);
        cancelAddAssetBtn.addEventListener('click', closeAddAssetModal);

        transactionTypeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'absolute') {
                    transactionAmountSection.classList.add('hidden');
                    transactionAbsoluteValueSection.classList.remove('hidden');
                } else {
                    transactionAmountSection.classList.remove('hidden');
                    transactionAbsoluteValueSection.classList.add('hidden');
                }
            });
        });
        applyTransactionBtn.addEventListener('click', handleUpdateAssetValue);
        cancelTransactionBtn.addEventListener('click', closeAdjustValueModal);

        saveEditedAssetBtn.addEventListener('click', handleEditAssetSubmit);
        cancelEditAssetBtn.addEventListener('click', closeEditAssetModal);

        // New: Account Group Management Listeners
        addGroupBtn.addEventListener('click', handleAddGroup);
        saveEditedGroupBtn.addEventListener('click', handleEditGroupSubmit);
        cancelEditGroupBtn.addEventListener('click', closeEditGroupModal);

        // CSV History Import/Export Listeners
        uploadHistoryCsvBtn.addEventListener('click', uploadHistoryFromCSV);
        exportHistoryCsvBtn.addEventListener('click', exportHistoryToCSV);

        // Chart Aggregation Listener
        chartAggregationSelect.addEventListener('change', (e) => {
            currentChartAggregation = e.target.value;
            renderNetWorthChart(); // Re-render chart with new aggregation
        });

        // New: Currency Rate Management Listener
        saveCurrencyRatesBtn.addEventListener('click', handleSaveCurrencyRates);

    </script>
</body>
</html>
