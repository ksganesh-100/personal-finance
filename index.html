<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Net Worth Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6; /* Light gray background */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        .container {
            width: 100%;
            max-width: 1200px; /* Max width for content */
            padding: 1rem;
            box-sizing: border-box;
        }
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="app" class="container mx-auto p-4 bg-white shadow-lg rounded-lg mt-8 mb-8">
        <!-- Loading State -->
        <div id="loading-state" class="flex items-center justify-center min-h-screen hidden">
            <div class="text-xl font-semibold text-gray-700">Loading Net Worth Tracker...</div>
        </div>

        <!-- Error State -->
        <div id="error-state" class="flex items-center justify-center min-h-screen hidden">
            <div class="text-xl font-semibold text-red-600 p-4 bg-red-100 rounded-lg">Error: <span id="error-message"></span></div>
        </div>

        <!-- Main Application Content (initially hidden) -->
        <div id="main-content" class="hidden">
            <h1 class="text-4xl font-bold text-center text-gray-800 mb-6">Net Worth Tracker</h1>
            <p class="text-center text-gray-600 mb-8">
                Welcome, User ID: <span id="user-id-display"></span>! Track your financial journey.
            </p>

            <!-- Net Worth Summary -->
            <div class="bg-blue-600 text-white p-6 rounded-lg shadow-md mb-8 flex flex-col md:flex-row items-center justify-between">
                <div class="flex items-center mb-4 md:mb-0">
                    <!-- DollarSign Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 mr-4"><circle cx="12" cy="12" r="10"></circle><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path><path d="M12 2v20"></path></svg>
                    <div>
                        <h2 class="text-2xl font-semibold">Total Net Worth</h2>
                        <p id="total-net-worth" class="text-4xl font-bold mt-2"></p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <label for="currency-select" class="text-lg">Display in:</label>
                    <select
                        id="currency-select"
                        class="p-2 rounded-md bg-blue-700 text-white border border-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-400"
                    >
                        <option value="INR">INR</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                    </select>
                    <button
                        id="take-snapshot-btn"
                        class="bg-blue-700 hover:bg-blue-800 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-200 ease-in-out transform hover:scale-105"
                    >
                        Take Snapshot
                    </button>
                </div>
            </div>

            <!-- Add Asset Button -->
            <div class="flex justify-end mb-6">
                <button
                    id="add-asset-btn"
                    class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center"
                >
                    <!-- Plus Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M12 5v14"></path><path d="M5 12h14"></path></svg>
                    Add New Asset
                </button>
            </div>

            <!-- Assets List -->
            <div class="mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    <!-- LayoutGrid Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    Your Assets
                </h2>
                <p id="no-assets-message" class="text-gray-500 text-center py-8 hidden">No assets added yet. Click "Add New Asset" to get started!</p>
                <div id="assets-table-container" class="overflow-x-auto rounded-lg shadow-md hidden">
                    <table class="min-w-full bg-white border-collapse">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider rounded-tl-lg">Asset Name</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">Group</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">Value</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">Value (<span id="display-currency-assets">INR</span>)</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">Last Updated</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider rounded-tr-lg">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="assets-table-body" class="divide-y divide-gray-200">
                            <!-- Asset rows will be injected here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-end mt-4">
                    <button
                        id="export-csv-btn"
                        class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-200 ease-in-out transform hover:scale-105 flex items-center"
                    >
                        Export to CSV
                    </button>
                </div>
            </div>

            <!-- Net Worth Historical Graph -->
            <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    <!-- BarChart Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
                    Net Worth History
                </h2>
                <p id="no-history-message" class="text-gray-500 text-center py-8 hidden">Take a few snapshots to see your net worth history here.</p>
                <div id="net-worth-chart-container" class="relative w-full h-80 hidden">
                    <canvas id="netWorthChart"></canvas>
                </div>
            </div>

            <!-- Asset Allocation Pie Chart -->
            <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    <!-- LayoutGrid Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    Asset Allocation
                </h2>
                <p id="no-allocation-message" class="text-gray-500 text-center py-8 hidden">Add assets to see your allocation breakdown.</p>
                <div id="allocation-chart-container" class="relative w-full h-80 hidden">
                    <canvas id="assetAllocationChart"></canvas>
                </div>
            </div>

            <!-- Transaction Log -->
            <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                    <!-- BarChart Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
                    Transaction History
                </h2>
                <p id="no-transactions-message" class="text-gray-500 text-center py-8 hidden">No transactions recorded yet.</p>
                <div id="transactions-table-container" class="overflow-x-auto rounded-lg shadow-md hidden">
                    <table class="min-w-full bg-white border-collapse">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider rounded-tl-lg">Date</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">Asset</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">Type</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">Amount Changed</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider">New Value</th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-gray-700 uppercase tracking-wider rounded-tr-lg">Description</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table-body" class="divide-y divide-gray-200">
                            <!-- Transaction rows will be injected here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Asset Modal -->
    <div id="add-asset-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Add New Asset</h3>
            <p id="add-asset-error" class="text-red-500 mb-4 hidden"></p>
            <div class="mb-4">
                <label for="new-asset-name" class="block text-gray-700 text-sm font-bold mb-2">Asset Name:</label>
                <input
                    type="text"
                    id="new-asset-name"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    placeholder="e.g., Savings Account, Google Stock"
                />
            </div>
            <div class="mb-4">
                <label for="new-asset-value" class="block text-gray-700 text-sm font-bold mb-2">Current Value:</label>
                <input
                    type="number"
                    id="new-asset-value"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    min="0"
                    step="0.01"
                    placeholder="e.g., 10000.00"
                />
            </div>
            <div class="mb-4">
                <label for="new-asset-currency" class="block text-gray-700 text-sm font-bold mb-2">Currency:</label>
                <select
                    id="new-asset-currency"
                    class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                >
                    <option value="INR">INR</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                </select>
            </div>
            <div class="mb-6">
                <label for="new-asset-group" class="block text-gray-700 text-sm font-bold mb-2">Asset Group:</label>
                <select
                    id="new-asset-group"
                    class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                >
                    <option value="">Select a group (Optional)</option>
                    <option value="Banks">Banks</option>
                    <option value="Brokerage Accounts">Brokerage Accounts</option>
                    <option value="Mutual Funds">Mutual Funds</option>
                    <option value="Immovable assets">Immovable assets</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="flex items-center justify-between">
                <button
                    id="save-new-asset-btn"
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                    Add Asset
                </button>
                <button
                    id="cancel-add-asset-btn"
                    class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Adjust Value Modal -->
    <div id="adjust-value-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Adjust Value for <span id="adjust-asset-name"></span> (<span id="adjust-asset-currency"></span>)</h3>
            <p class="text-gray-600 mb-4">Current Value: <span id="adjust-current-value"></span></p>
            <p id="adjust-value-error" class="text-red-500 mb-4 hidden"></p>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Update Type:</label>
                <div class="flex space-x-4">
                    <label class="inline-flex items-center">
                        <input
                            type="radio"
                            class="form-radio text-blue-600"
                            name="transactionType"
                            value="add"
                            checked
                        />
                        <span class="ml-2">Add</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input
                            type="radio"
                            class="form-radio text-blue-600"
                            name="transactionType"
                            value="subtract"
                        />
                        <span class="ml-2">Subtract</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input
                            type="radio"
                            class="form-radio text-blue-600"
                            name="transactionType"
                            value="absolute"
                        />
                        <span class="ml-2">Set Absolute Value</span>
                    </label>
                </div>
            </div>

            <div id="transaction-amount-section" class="mb-4">
                <label for="transaction-amount" class="block text-gray-700 text-sm font-bold mb-2">Amount:</label>
                <input
                    type="number"
                    id="transaction-amount"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    min="0"
                    step="0.01"
                    placeholder="e.g., 500.00"
                />
            </div>
            <div id="transaction-absolute-value-section" class="mb-4 hidden">
                <label for="transaction-absolute-value" class="block text-gray-700 text-sm font-bold mb-2">New Absolute Value:</label>
                <input
                    type="number"
                    id="transaction-absolute-value"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    min="0"
                    step="0.01"
                    placeholder="e.g., 10500.00"
                />
            </div>

            <div class="mb-6">
                <label for="transaction-description" class="block text-gray-700 text-sm font-bold mb-2">Description (Optional):</label>
                <input
                    type="text"
                    id="transaction-description"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    placeholder="e.g., Monthly deposit, Stock sale"
                />
            </div>
            <div class="flex items-center justify-between">
                <button
                    id="apply-transaction-btn"
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                    Apply Change
                </button>
                <button
                    id="cancel-transaction-btn"
                    class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Asset Modal -->
    <div id="edit-asset-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Edit Asset</h3>
            <p id="edit-asset-error" class="text-red-500 mb-4 hidden"></p>
            <div class="mb-4">
                <label for="edit-asset-name" class="block text-gray-700 text-sm font-bold mb-2">Asset Name:</label>
                <input
                    type="text"
                    id="edit-asset-name"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                    placeholder="e.g., Savings Account"
                />
            </div>
            <div class="mb-6">
                <label for="edit-asset-group" class="block text-gray-700 text-sm font-bold mb-2">Asset Group:</label>
                <select
                    id="edit-asset-group"
                    class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                >
                    <option value="">Select a group (Optional)</option>
                    <option value="Banks">Banks</option>
                    <option value="Brokerage Accounts">Brokerage Accounts</option>
                    <option value="Mutual Funds">Mutual Funds</option>
                    <option value="Immovable assets">Immovable assets</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="flex items-center justify-between">
                <button
                    id="save-edited-asset-btn"
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                    Save Changes
                </button>
                <button
                    id="cancel-edit-asset-btn"
                    class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Chart.js CDN (for graphs) - Loaded as a regular script -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase CDN -->
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, onSnapshot, addDoc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your Firebase project configuration
        const firebaseConfig = {
          apiKey: "AIzaSyAG5hRXMoRCAJtE_SK_9vAHKzTfPDzWips",
          authDomain: "personal-finance-b265a.firebaseapp.com",
          projectId: "personal-finance-b265a",
          storageBucket: "personal-finance-b265a.firebasestorage.app",
          messagingSenderId: "704749934703",
          appId: "1:704749934703:web:2b5d572df1e2819cf1d59a",
          measurementId: "G-DXTCNEJ57E"
        };

        // Global Firebase instances and data
        let app;
        let db;
        let auth;
        let currentUser = null;
        let assetsData = [];
        let transactionsData = [];
        let netWorthSnapshotsData = [];
        let primaryDisplayCurrency = 'INR';
        let selectedAssetForAdjustment = null; // Stores the asset object for adjustment modal
        let currentEditAssetId = null; // Stores the ID of the asset being edited

        // Chart instances
        let netWorthChartInstance = null;
        let allocationChartInstance = null;

        // DOM Element References
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const errorMessageSpan = document.getElementById('error-message');
        const mainContent = document.getElementById('main-content');
        const userIdDisplay = document.getElementById('user-id-display');
        const totalNetWorthDisplay = document.getElementById('total-net-worth');
        const currencySelect = document.getElementById('currency-select');
        const takeSnapshotBtn = document.getElementById('take-snapshot-btn');
        const addAssetBtn = document.getElementById('add-asset-btn');
        const assetsTableBody = document.getElementById('assets-table-body');
        const noAssetsMessage = document.getElementById('no-assets-message');
        const assetsTableContainer = document.getElementById('assets-table-container');
        const displayCurrencyAssets = document.getElementById('display-currency-assets');
        const exportCsvBtn = document.getElementById('export-csv-btn'); // New: CSV export button

        const netWorthChartCanvas = document.getElementById('netWorthChart');
        const noHistoryMessage = document.getElementById('no-history-message');
        const netWorthChartContainer = document.getElementById('net-worth-chart-container');

        const assetAllocationChartCanvas = document.getElementById('assetAllocationChart');
        const noAllocationMessage = document.getElementById('no-allocation-message');
        const allocationChartContainer = document.getElementById('allocation-chart-container');

        const transactionsTableBody = document.getElementById('transactions-table-body');
        const noTransactionsMessage = document.getElementById('no-transactions-message');
        const transactionsTableContainer = document.getElementById('transactions-table-container');

        // Modals
        const addAssetModal = document.getElementById('add-asset-modal');
        const addAssetError = document.getElementById('add-asset-error');
        const newAssetNameInput = document.getElementById('new-asset-name');
        const newAssetValueInput = document.getElementById('new-asset-value');
        const newAssetCurrencySelect = document.getElementById('new-asset-currency');
        const newAssetGroupSelect = document.getElementById('new-asset-group');
        const saveNewAssetBtn = document.getElementById('save-new-asset-btn');
        const cancelAddAssetBtn = document.getElementById('cancel-add-asset-btn');

        const adjustValueModal = document.getElementById('adjust-value-modal');
        const adjustAssetNameSpan = document.getElementById('adjust-asset-name');
        const adjustAssetCurrencySpan = document.getElementById('adjust-asset-currency');
        const adjustCurrentValueSpan = document.getElementById('adjust-current-value');
        const adjustValueError = document.getElementById('adjust-value-error');
        const transactionTypeRadios = document.querySelectorAll('input[name="transactionType"]');
        const transactionAmountSection = document.getElementById('transaction-amount-section');
        const transactionAmountInput = document.getElementById('transaction-amount');
        const transactionAbsoluteValueSection = document.getElementById('transaction-absolute-value-section');
        const transactionAbsoluteValueInput = document.getElementById('transaction-absolute-value');
        const transactionDescriptionInput = document.getElementById('transaction-description');
        const applyTransactionBtn = document.getElementById('apply-transaction-btn');
        const cancelTransactionBtn = document.getElementById('cancel-transaction-btn');

        const editAssetModal = document.getElementById('edit-asset-modal');
        const editAssetError = document.getElementById('edit-asset-error');
        const editAssetNameInput = document.getElementById('edit-asset-name');
        const editAssetGroupSelect = document.getElementById('edit-asset-group');
        const saveEditedAssetBtn = document.getElementById('save-edited-asset-btn');
        const cancelEditAssetBtn = document.getElementById('cancel-edit-asset-btn');


        // Exchange rates (simplified, hardcoded)
        const EXCHANGE_RATES = {
            USD_TO_INR: 83.5,
            EUR_TO_INR: 90.0,
            INR_TO_USD: 1 / 83.5,
            INR_TO_EUR: 1 / 90.0,
            USD_TO_EUR: 0.92,
            EUR_TO_USD: 1 / 0.92
        };

        // Function to convert value to a target currency
        function convertCurrency(value, fromCurrency, toCurrency) {
            if (fromCurrency === toCurrency) {
                return value;
            }

            let valueInINR = value;
            if (fromCurrency === 'USD') {
                valueInINR = value * EXCHANGE_RATES.USD_TO_INR;
            } else if (fromCurrency === 'EUR') {
                valueInINR = value * EXCHANGE_RATES.EUR_TO_INR;
            }

            if (toCurrency === 'INR') {
                return valueInINR;
            } else if (toCurrency === 'USD') {
                return valueInINR * EXCHANGE_RATES.INR_TO_USD;
            } else if (toCurrency === 'EUR') {
                return valueInINR * EXCHANGE_RATES.INR_TO_EUR;
            }
            return value;
        }

        // --- UI State Management ---
        function showLoading() {
            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');
            mainContent.classList.add('hidden');
        }

        function showError(message) {
            loadingState.classList.add('hidden');
            errorState.classList.remove('hidden');
            mainContent.classList.add('hidden');
            errorMessageSpan.textContent = message;
        }

        function showApp() {
            loadingState.classList.add('hidden');
            errorState.classList.add('hidden');
            mainContent.classList.remove('hidden');
        }

        function showModal(modalElement, errorElement) {
            modalElement.classList.remove('hidden');
            if (errorElement) errorElement.classList.add('hidden');
        }

        function hideModal(modalElement, errorElement) {
            modalElement.classList.add('hidden');
            if (errorElement) errorElement.classList.add('hidden');
        }

        // --- Firebase Initialization ---
        async function initializeFirebase() {
            showLoading();
            if (firebaseConfig && firebaseConfig.projectId) {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    console.log("Firebase initialized successfully.");

                    // Listen for auth state changes
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            currentUser = user;
                            userIdDisplay.textContent = currentUser.uid;
                            console.log("User authenticated:", currentUser.uid);
                            await loadInitialData(currentUser.uid);
                            showApp();
                        } else {
                            console.log("No user signed in. Attempting anonymous sign-in...");
                            try {
                                await signInAnonymously(auth);
                                console.log("Signed in anonymously.");
                            } catch (err) {
                                console.error("Firebase Auth Error:", err);
                                showError("Failed to authenticate. Please check Firebase Auth settings (Anonymous Sign-in).");
                            }
                        }
                    });

                } catch (error) {
                    console.error("Error initializing Firebase:", error);
                    showError("Failed to initialize Firebase. Check console for details.");
                }
            } else {
                showError("Firebase configuration is missing. Please ensure projectId is provided in the script.");
            }
        }

        // --- Data Fetching and Real-time Listeners ---
        async function loadInitialData(uid) {
            if (!db || !uid) {
                showError("Database or User ID not available for data loading.");
                return;
            }

            // Assets listener
            const assetsCollectionRef = collection(db, `artifacts/${firebaseConfig.projectId}/users/${uid}/assets`);
            onSnapshot(assetsCollectionRef, (snapshot) => {
                assetsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAssetsTable();
                updateNetWorthSummary();
                renderAllocationChart();
            }, (err) => {
                console.error("Error fetching assets:", err);
                showError("Failed to load assets.");
            });

            // Transactions listener
            const transactionsCollectionRef = collection(db, `artifacts/${firebaseConfig.projectId}/users/${uid}/transactions`);
            onSnapshot(transactionsCollectionRef, (snapshot) => {
                transactionsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                transactionsData.sort((a, b) => b.timestamp - a.timestamp); // Sort descending
                renderTransactionsTable();
            }, (err) => {
                console.error("Error fetching transactions:", err);
                showError("Failed to load transactions.");
            });

            // Net Worth Snapshots listener
            const netWorthSnapshotsCollectionRef = collection(db, `artifacts/${firebaseConfig.projectId}/users/${uid}/netWorthSnapshots`);
            onSnapshot(netWorthSnapshotsCollectionRef, (snapshot) => {
                netWorthSnapshotsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                netWorthSnapshotsData.sort((a, b) => a.timestamp - b.timestamp); // Sort ascending for chart
                renderNetWorthChart();
            }, (err) => {
                console.error("Error fetching net worth snapshots:", err);
                showError("Failed to load net worth history.");
            });
        }

        // --- UI Rendering Functions ---
        function formatCurrency(value, currencyCode, includeDecimals = true) {
            return value.toLocaleString(undefined, {
                style: 'currency',
                currency: currencyCode,
                minimumFractionDigits: includeDecimals ? 2 : 0,
                maximumFractionDigits: includeDecimals ? 2 : 0
            });
        }

        function updateNetWorthSummary() {
            let total = 0;
            assetsData.forEach(asset => {
                total += convertCurrency(asset.value, asset.currency, primaryDisplayCurrency);
            });
            // Point 5: Remove decimal points from total net worth
            totalNetWorthDisplay.textContent = formatCurrency(total, primaryDisplayCurrency, false);
            displayCurrencyAssets.textContent = primaryDisplayCurrency; // Update header
        }

        function renderAssetsTable() {
            assetsTableBody.innerHTML = ''; // Clear existing rows

            // Point 1: Sort assets by group and then alphabetically within groups
            const sortedAssets = [...assetsData].sort((a, b) => {
                const groupA = a.group || 'Other';
                const groupB = b.group || 'Other';
                if (groupA < groupB) return -1;
                if (groupA > groupB) return 1;
                return a.name.localeCompare(b.name);
            });

            if (sortedAssets.length === 0) {
                noAssetsMessage.classList.remove('hidden');
                assetsTableContainer.classList.add('hidden');
            } else {
                noAssetsMessage.classList.add('hidden');
                assetsTableContainer.classList.remove('hidden');

                let currentGroup = null;
                let groupSubtotal = 0;

                sortedAssets.forEach((asset, index) => {
                    const assetGroup = asset.group || 'Other';

                    // Point 2: Add sub-totals for each asset group
                    if (assetGroup !== currentGroup && currentGroup !== null) {
                        const subtotalRow = assetsTableBody.insertRow();
                        subtotalRow.className = 'bg-gray-100 font-semibold border-t-2 border-gray-300';
                        subtotalRow.innerHTML = `
                            <td class="py-2 px-4 whitespace-nowrap text-right" colspan="2">Total ${currentGroup}:</td>
                            <td class="py-2 px-4 whitespace-nowrap text-gray-800" colspan="3">
                                ${formatCurrency(groupSubtotal, primaryDisplayCurrency)}
                            </td>
                            <td class="py-2 px-4"></td>
                        `;
                        groupSubtotal = 0; // Reset subtotal for the new group
                    }
                    currentGroup = assetGroup;
                    groupSubtotal += convertCurrency(asset.value, asset.currency, primaryDisplayCurrency);


                    const row = assetsTableBody.insertRow();
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-4 whitespace-nowrap text-gray-900">${asset.name}</td>
                        <td class="py-3 px-4 whitespace-nowrap text-gray-700">${asset.group}</td>
                        <td class="py-3 px-4 whitespace-nowrap text-gray-700">
                            ${formatCurrency(asset.value, asset.currency)}
                        </td>
                        <td class="py-3 px-4 whitespace-nowrap text-gray-700">
                            ${formatCurrency(convertCurrency(asset.value, asset.currency, primaryDisplayCurrency), primaryDisplayCurrency)}
                        </td>
                        <td class="py-3 px-4 whitespace-nowrap text-gray-700">
                            ${new Date(asset.updatedAt).toLocaleString()}
                        </td>
                        <td class="py-3 px-4 whitespace-nowrap">
                            <div class="flex space-x-2">
                                <button data-id="${asset.id}" class="adjust-value-btn bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-full shadow-sm transition duration-200 ease-in-out transform hover:scale-110" title="Adjust Value">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"></path><path d="M5 12h14"></path></svg>
                                </button>
                                <button data-id="${asset.id}" class="edit-asset-btn bg-yellow-500 hover:bg-yellow-600 text-white p-2 rounded-full shadow-sm transition duration-200 ease-in-out transform hover:scale-110" title="Edit Asset">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                </button>
                                <button data-id="${asset.id}" class="delete-asset-btn bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-sm transition duration-200 ease-in-out transform hover:scale-110" title="Delete Asset">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </button>
                            </div>
                        </td>
                    `;
                    // Add event listeners to the new buttons
                    row.querySelector('.adjust-value-btn').addEventListener('click', (e) => openAdjustValueModal(e.currentTarget.dataset.id));
                    row.querySelector('.edit-asset-btn').addEventListener('click', (e) => openEditAssetModal(e.currentTarget.dataset.id));
                    row.querySelector('.delete-asset-btn').addEventListener('click', (e) => handleDeleteAsset(e.currentTarget.dataset.id));
                });

                // Add the last group's subtotal after the loop
                if (currentGroup !== null) {
                    const subtotalRow = assetsTableBody.insertRow();
                    subtotalRow.className = 'bg-gray-100 font-semibold border-t-2 border-gray-300';
                    subtotalRow.innerHTML = `
                        <td class="py-2 px-4 whitespace-nowrap text-right" colspan="2">Total ${currentGroup}:</td>
                        <td class="py-2 px-4 whitespace-nowrap text-gray-800" colspan="3">
                            ${formatCurrency(groupSubtotal, primaryDisplayCurrency)}
                        </td>
                        <td class="py-2 px-4"></td>
                    `;
                }
            }
        }

        function renderTransactionsTable() {
            transactionsTableBody.innerHTML = ''; // Clear existing rows
            if (transactionsData.length === 0) {
                noTransactionsMessage.classList.remove('hidden');
                transactionsTableContainer.classList.add('hidden');
            } else {
                noTransactionsMessage.classList.add('hidden');
                transactionsTableContainer.classList.remove('hidden');
                transactionsData.forEach(tx => {
                    const row = transactionsTableBody.insertRow();
                    row.className = 'hover:bg-gray-50';
                    const assetCurrency = assetsData.find(a => a.id === tx.assetId)?.currency || primaryDisplayCurrency;
                    const amountChangedClass = tx.amountChanged >= 0 ? 'text-green-600' : 'text-red-600';
                    const typeText = tx.type === 'add' ? 'Add' : tx.type === 'subtract' ? 'Subtract' : 'Update';
                    const typeClass = tx.type === 'add' ? 'text-green-600' : tx.type === 'subtract' ? 'text-red-600' : 'text-blue-600';

                    row.innerHTML = `
                        <td class="py-3 px-4 whitespace-nowrap text-gray-900">
                            ${new Date(tx.timestamp).toLocaleString()}
                        </td>
                        <td class="py-3 px-4 whitespace-nowrap text-gray-700">${tx.assetName}</td>
                        <td class="py-3 px-4 whitespace-nowrap text-gray-700">
                            <span class="font-semibold ${typeClass}">${typeText}</span>
                        </td>
                        <td class="py-3 px-4 whitespace-nowrap ${amountChangedClass}">
                            ${formatCurrency(tx.amountChanged, assetCurrency)}
                        </td>
                        <td class="py-3 px-4 whitespace-nowrap text-gray-700">
                            ${formatCurrency(tx.newValue, assetCurrency)}
                        </td>
                        <td class="py-3 px-4 text-gray-700">${tx.description}</td>
                    `;
                });
            }
        }

        function renderNetWorthChart() {
            if (netWorthSnapshotsData.length < 2) {
                noHistoryMessage.classList.remove('hidden');
                netWorthChartContainer.classList.add('hidden');
                if (netWorthChartInstance) {
                    netWorthChartInstance.destroy();
                    netWorthChartInstance = null;
                }
                return;
            } else {
                noHistoryMessage.classList.add('hidden');
                netWorthChartContainer.classList.remove('hidden');
            }

            // Point 8: Use toLocaleString() to include time for unique X-axis labels
            const labels = netWorthSnapshotsData.map(s => new Date(s.timestamp).toLocaleString());
            const data = netWorthSnapshotsData.map(s => s.totalNetWorth);

            if (netWorthChartInstance) {
                netWorthChartInstance.data.labels = labels;
                netWorthChartInstance.data.datasets[0].data = data;
                netWorthChartInstance.data.datasets[0].label = `Net Worth (${primaryDisplayCurrency})`;
                netWorthChartInstance.update();
            } else {
                netWorthChartInstance = new Chart(netWorthChartCanvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Net Worth (${primaryDisplayCurrency})`,
                            data: data,
                            borderColor: '#8884d8',
                            tension: 0.1,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value, primaryDisplayCurrency);
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${formatCurrency(context.raw, primaryDisplayCurrency)}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function renderAllocationChart() {
            const allocation = {};
            assetsData.forEach(asset => {
                const valueInPrimary = convertCurrency(asset.value, asset.currency, primaryDisplayCurrency);
                allocation[asset.group] = (allocation[asset.group] || 0) + valueInPrimary;
            });

            const allocationData = Object.keys(allocation).map(group => ({
                name: group,
                value: allocation[group]
            }));

            if (allocationData.length === 0 || allocationData.every(d => d.value === 0)) {
                noAllocationMessage.classList.remove('hidden');
                allocationChartContainer.classList.add('hidden');
                if (allocationChartInstance) {
                    allocationChartInstance.destroy();
                    allocationChartInstance = null;
                }
                return;
            } else {
                noAllocationMessage.classList.add('hidden');
                allocationChartContainer.classList.remove('hidden');
            }

            const labels = allocationData.map(d => d.name);
            const data = allocationData.map(d => d.value);
            const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#AF19FF', '#FF19A3'];

            if (allocationChartInstance) {
                allocationChartInstance.data.labels = labels;
                allocationChartInstance.data.datasets[0].data = data;
                allocationChartInstance.data.datasets[0].backgroundColor = labels.map((_, i) => COLORS[i % COLORS.length]);
                allocationChartInstance.update();
            } else {
                allocationChartInstance = new Chart(assetAllocationChartCanvas, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: labels.map((_, i) => COLORS[i % COLORS.length]),
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let sum = 0;
                                        let dataArr = context.dataset.data;
                                        for (let i = 0; i < dataArr.length; i++) {
                                            sum += dataArr[i];
                                        }
                                        let percentage = (context.raw * 100 / sum).toFixed(0) + '%';
                                        return `${context.label}: ${formatCurrency(context.raw, primaryDisplayCurrency)} (${percentage})`;
                                    }
                                }
                            },
                            legend: {
                                position: 'right',
                            }
                        }
                    }
                });
            }
        }

        // --- Modal Functions ---
        function openAddAssetModal() {
            newAssetNameInput.value = '';
            newAssetValueInput.value = '';
            newAssetCurrencySelect.value = 'INR';
            newAssetGroupSelect.value = '';
            showModal(addAssetModal, addAssetError);
        }

        function closeAddAssetModal() {
            hideModal(addAssetModal, addAssetError);
        }

        function openAdjustValueModal(assetId) {
            selectedAssetForAdjustment = assetsData.find(asset => asset.id === assetId);
            if (selectedAssetForAdjustment) {
                adjustAssetNameSpan.textContent = selectedAssetForAdjustment.name;
                adjustAssetCurrencySpan.textContent = selectedAssetForAdjustment.currency;
                adjustCurrentValueSpan.textContent = formatCurrency(selectedAssetForAdjustment.value, selectedAssetForAdjustment.currency);
                transactionAmountInput.value = '';
                transactionAbsoluteValueInput.value = '';
                transactionDescriptionInput.value = '';
                // Reset radio buttons to 'add' and show amount section
                document.querySelector('input[name="transactionType"][value="add"]').checked = true;
                transactionAmountSection.classList.remove('hidden');
                transactionAbsoluteValueSection.classList.add('hidden');
                showModal(adjustValueModal, adjustValueError);
            } else {
                console.error("Asset not found for adjustment:", assetId);
                showError("Asset not found for adjustment.");
            }
        }

        function closeAdjustValueModal() {
            hideModal(adjustValueModal, adjustValueError);
            selectedAssetForAdjustment = null;
        }

        function openEditAssetModal(assetId) {
            currentEditAssetId = assetId;
            const assetToEdit = assetsData.find(asset => asset.id === assetId);
            if (assetToEdit) {
                editAssetNameInput.value = assetToEdit.name;
                editAssetGroupSelect.value = assetToEdit.group || '';
                showModal(editAssetModal, editAssetError);
            } else {
                console.error("Asset not found for editing:", assetId);
                showError("Asset not found for editing.");
            }
        }

        function closeEditAssetModal() {
            hideModal(editAssetModal, editAssetError);
            currentEditAssetId = null;
        }

        // --- Event Handlers ---
        async function handleAddAssetSubmit() {
            if (!currentUser || !db) {
                addAssetError.textContent = "User not authenticated or database not ready.";
                addAssetError.classList.remove('hidden');
                return;
            }
            const name = newAssetNameInput.value.trim();
            const value = parseFloat(newAssetValueInput.value);
            const currency = newAssetCurrencySelect.value;
            const group = newAssetGroupSelect.value || 'Other';

            if (!name || isNaN(value) || value <= 0) {
                addAssetError.textContent = "Please enter a valid asset name and a positive numeric value.";
                addAssetError.classList.remove('hidden');
                return;
            }

            try {
                const assetsCollectionRef = collection(db, `artifacts/${firebaseConfig.projectId}/users/${currentUser.uid}/assets`);
                await addDoc(assetsCollectionRef, {
                    name: name,
                    value: value,
                    currency: currency,
                    group: group,
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                });
                closeAddAssetModal();
            } catch (err) {
                console.error("Error adding asset:", err);
                addAssetError.textContent = "Failed to add asset: " + err.message;
                addAssetError.classList.remove('hidden');
            }
        }

        async function handleUpdateAssetValue() {
            if (!currentUser || !db || !selectedAssetForAdjustment) {
                adjustValueError.textContent = "User not authenticated, database not ready, or no asset selected.";
                adjustValueError.classList.remove('hidden');
                return;
            }

            let newValue;
            let amountChanged;
            let transactionDescriptionText = transactionDescriptionInput.value.trim();
            let transactionType = document.querySelector('input[name="transactionType"]:checked').value;

            if (transactionType === 'absolute') {
                const absoluteVal = parseFloat(transactionAbsoluteValueInput.value);
                if (isNaN(absoluteVal) || absoluteVal < 0) {
                    adjustValueError.textContent = "Please enter a valid non-negative absolute value.";
                    adjustValueError.classList.remove('hidden');
                    return;
                }
                amountChanged = absoluteVal - selectedAssetForAdjustment.value;
                newValue = absoluteVal;
                transactionDescriptionText = transactionDescriptionText || `Updated to absolute value ${formatCurrency(absoluteVal, selectedAssetForAdjustment.currency)}`;
            } else {
                const amount = parseFloat(transactionAmountInput.value);
                if (isNaN(amount) || amount <= 0) {
                    adjustValueError.textContent = "Please enter a valid positive amount for the transaction.";
                    adjustValueError.classList.remove('hidden');
                    return;
                }

                if (transactionType === 'add') {
                    newValue = selectedAssetForAdjustment.value + amount;
                    amountChanged = amount;
                    transactionDescriptionText = transactionDescriptionText || `Added ${formatCurrency(amount, selectedAssetForAdjustment.currency)} to ${selectedAssetForAdjustment.name}`;
                } else { // subtract
                    newValue = selectedAssetForAdjustment.value - amount;
                    amountChanged = -amount;
                    transactionDescriptionText = transactionDescriptionText || `Subtracted ${formatCurrency(amount, selectedAssetForAdjustment.currency)} from ${selectedAssetForAdjustment.name}`;
                }

                if (newValue < 0) {
                    adjustValueError.textContent = "Asset value cannot go below zero.";
                    adjustValueError.classList.remove('hidden');
                    return;
                }
            }

            try {
                const assetDocRef = doc(db, `artifacts/${firebaseConfig.projectId}/users/${currentUser.uid}/assets`, selectedAssetForAdjustment.id);
                await updateDoc(assetDocRef, {
                    value: newValue,
                    updatedAt: Date.now()
                });

                // Record transaction
                const transactionsCollectionRef = collection(db, `artifacts/${firebaseConfig.projectId}/users/${currentUser.uid}/transactions`);
                await addDoc(transactionsCollectionRef, {
                    assetId: selectedAssetForAdjustment.id,
                    assetName: selectedAssetForAdjustment.name,
                    oldValue: selectedAssetForAdjustment.value,
                    newValue: newValue,
                    amountChanged: amountChanged,
                    type: transactionType,
                    description: transactionDescriptionText,
                    timestamp: Date.now()
                });

                closeAdjustValueModal();
            } catch (err) {
                console.error("Error updating asset value or recording transaction:", err);
                adjustValueError.textContent = "Failed to update asset value or record transaction: " + err.message;
                adjustValueError.classList.remove('hidden');
            }
        }

        async function handleEditAssetSubmit() {
            if (!currentUser || !db || !currentEditAssetId) {
                editAssetError.textContent = "User not authenticated or database not ready.";
                editAssetError.classList.remove('hidden');
                return;
            }
            const name = editAssetNameInput.value.trim();
            const group = editAssetGroupSelect.value || 'Other';

            if (!name) {
                editAssetError.textContent = "Asset name cannot be empty.";
                editAssetError.classList.remove('hidden');
                return;
            }

            try {
                const assetDocRef = doc(db, `artifacts/${firebaseConfig.projectId}/users/${currentUser.uid}/assets`, currentEditAssetId);
                await updateDoc(assetDocRef, {
                    name: name,
                    group: group,
                    updatedAt: Date.now()
                });
                closeEditAssetModal();
            } catch (err) {
                console.error("Error editing asset:", err);
                editAssetError.textContent = "Failed to edit asset: " + err.message;
                editAssetError.classList.remove('hidden');
            }
        }

        async function handleDeleteAsset(assetId) {
            if (!currentUser || !db) {
                showError("User not authenticated or database not ready.");
                return;
            }
            if (!confirm("Are you sure you want to delete this asset and all its associated transactions?")) {
                return;
            }

            try {
                // Delete asset document
                await deleteDoc(doc(db, `artifacts/${firebaseConfig.projectId}/users/${currentUser.uid}/assets`, assetId));

                // Delete associated transactions
                const transactionsRef = collection(db, `artifacts/${firebaseConfig.projectId}/users/${currentUser.uid}/transactions`);
                const q = query(transactionsRef, where("assetId", "==", assetId));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(async (doc) => {
                    await deleteDoc(doc.ref);
                });
            } catch (err) {
                console.error("Error deleting asset:", err);
                showError("Failed to delete asset: " + err.message);
            }
        }

        async function handleTakeSnapshot() {
            if (!currentUser || !db) {
                showError("User not authenticated or database not ready.");
                return;
            }
            try {
                let total = 0;
                assetsData.forEach(asset => {
                    total += convertCurrency(asset.value, asset.currency, primaryDisplayCurrency);
                });

                const snapshotsCollectionRef = collection(db, `artifacts/${firebaseConfig.projectId}/users/${currentUser.uid}/netWorthSnapshots`);
                await addDoc(snapshotsCollectionRef, {
                    totalNetWorth: total,
                    currency: primaryDisplayCurrency,
                    timestamp: Date.now()
                });
            } catch (err) {
                console.error("Error taking net worth snapshot:", err);
                showError("Failed to take net worth snapshot: " + err.message);
            }
        }

        // Point 6: CSV Export Function
        function exportAssetsToCSV() {
            if (assetsData.length === 0) {
                alert("No assets to export."); // Using alert for simplicity, replace with custom modal if needed.
                return;
            }

            const headers = ["Asset Name", "Group", "Value", "Currency", "Value (Primary Currency)", "Last Updated"];
            const rows = assetsData.map(asset => {
                const valueInPrimary = convertCurrency(asset.value, asset.currency, primaryDisplayCurrency);
                return [
                    `"${asset.name.replace(/"/g, '""')}"`, // Handle commas and quotes in name
                    `"${(asset.group || 'Other').replace(/"/g, '""')}"`,
                    asset.value.toFixed(2),
                    asset.currency,
                    valueInPrimary.toFixed(2),
                    new Date(asset.updatedAt).toLocaleString()
                ];
            });

            const csvContent = [
                headers.join(","),
                ...rows.map(row => row.join(","))
            ].join("\n");

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { // Feature detection for download attribute
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `net_worth_assets_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                // Fallback for browsers that don't support download attribute
                alert("Your browser does not support downloading files directly. Please copy the content below:\n\n" + csvContent);
            }
        }


        // --- Event Listeners Setup ---
        document.addEventListener('DOMContentLoaded', initializeFirebase);

        currencySelect.addEventListener('change', (e) => {
            primaryDisplayCurrency = e.target.value;
            updateNetWorthSummary();
            renderAssetsTable(); // Re-render to update converted values
            renderNetWorthChart();
            renderAllocationChart();
        });

        takeSnapshotBtn.addEventListener('click', handleTakeSnapshot);
        addAssetBtn.addEventListener('click', openAddAssetModal);
        saveNewAssetBtn.addEventListener('click', handleAddAssetSubmit);
        cancelAddAssetBtn.addEventListener('click', closeAddAssetModal);
        exportCsvBtn.addEventListener('click', exportAssetsToCSV); // New: CSV export button listener

        // Adjust Value Modal radio button logic
        transactionTypeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'absolute') {
                    transactionAmountSection.classList.add('hidden');
                    transactionAbsoluteValueSection.classList.remove('hidden');
                } else {
                    transactionAmountSection.classList.remove('hidden');
                    transactionAbsoluteValueSection.classList.add('hidden');
                }
            });
        });
        applyTransactionBtn.addEventListener('click', handleUpdateAssetValue);
        cancelTransactionBtn.addEventListener('click', closeAdjustValueModal);

        saveEditedAssetBtn.addEventListener('click', handleEditAssetSubmit);
        cancelEditAssetBtn.addEventListener('click', closeEditAssetModal);

    </script>
</body>
</html>
